<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Employee Portal â€“ Employee of the Month & Leave Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind for quick, simple styling -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-5xl bg-white shadow-xl rounded-2xl p-4 sm:p-6 mb-6">

    <!-- HEADER / LOGIN STATE -->
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
      <div>
        <h1 class="text-2xl font-bold">Employee Portal</h1>
        <p class="text-sm text-slate-500">
          Employee of the Month nominations & leave requests â€“ simple and staff-friendly.
        </p>
      </div>
      <div id="authArea" class="text-right">
        <!-- Filled by JS -->
      </div>
    </header>

    <!-- NAV TABS -->
    <nav id="mainNav" class="mb-4 hidden">
      <div class="inline-flex rounded-xl border bg-slate-50 overflow-hidden text-sm">
        <button data-section="nominate" class="tab-btn px-3 py-2 font-medium bg-white">
          Nominate
        </button>
        <button data-section="history" class="tab-btn px-3 py-2">
          Nomination History
        </button>
        <button data-section="leave" class="tab-btn px-3 py-2">
          Leave Request
        </button>
        <button data-section="availability" class="tab-btn px-3 py-2">
          Leave Availability
        </button>
      </div>
    </nav>

    <!-- LOGIN CARD (shown when logged out) -->
    <section id="loginSection" class="mt-4">
      <div class="border rounded-2xl p-6 text-center">
        <h2 class="text-xl font-semibold mb-2">Sign in to continue</h2>
        <p class="text-sm text-slate-500 mb-4">
          Please log in with your work Gmail to submit nominations and leave requests.
        </p>
        <button
          id="googleSignInBtn"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700"
        >
          <span>Sign in with Google</span>
        </button>
      </div>
    </section>

    <!-- MAIN APP (hidden until logged in) -->
    <main id="appSection" class="hidden">

      <!-- NOMINATE SECTION -->
      <section id="section-nominate" class="space-y-5">
        <h2 class="text-xl font-semibold">Employee of the Month Nomination</h2>
        <p class="text-sm text-slate-500">
          Please enter who you are nominating and why. Be as specific as possible â€“ real examples help.
        </p>

        <form id="nominationForm" class="space-y-4">
          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">Nominee name</label>
              <input
                id="nomineeName"
                type="text"
                required
                class="w-full border rounded-lg px-3 py-2 text-sm"
                placeholder="e.g. Remla A."
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Nominee department</label>
              <input
                id="nomineeDepartment"
                type="text"
                required
                class="w-full border rounded-lg px-3 py-2 text-sm"
                placeholder="e.g. Front Office / Housekeeping"
              />
            </div>
          </div>

          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">
                Guest feedback recognition points
              </label>
              <select
                id="guestFeedbackPoints"
                class="w-full border rounded-lg px-3 py-2 text-sm"
              >
                <option value="0">0 â€“ No guest comments yet</option>
                <option value="5">5 â€“ Some guest mentions</option>
                <option value="10">10 â€“ Frequent guest recognition</option>
                <option value="15">15 â€“ Outstanding guest feedback</option>
              </select>
              <p class="text-[11px] text-slate-400 mt-1">
                You can adjust this later as HR/manager based on actual guest reviews.
              </p>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">Nomination month</label>
              <input
                id="nominationMonth"
                type="month"
                class="w-full border rounded-lg px-3 py-2 text-sm"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Why are you nominating this person?</label>
            <textarea
              id="nominationReason"
              rows="4"
              required
              class="w-full border rounded-lg px-3 py-2 text-sm"
              placeholder="Describe specific moments, behavior, teamwork, guest comments, or leadership examples."
            ></textarea>
          </div>

          <button
            id="submitNominationBtn"
            type="submit"
            class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 disabled:opacity-60"
          >
            Submit nomination
          </button>
        </form>

        <div id="nominationMessage" class="text-sm mt-2"></div>
      </section>

      <!-- HISTORY SECTION -->
      <section id="section-history" class="space-y-4 hidden">
        <h2 class="text-xl font-semibold">Nomination History</h2>
        <p class="text-sm text-slate-500">
          Below are recent nominations. You can see who was nominated, by whom, and the reasons.
        </p>

        <div id="historyContainer" class="border rounded-2xl p-3 max-h-[420px] overflow-y-auto text-sm">
          <div id="historyList" class="space-y-3"></div>
        </div>
      </section>

      <!-- LEAVE REQUEST SECTION -->
      <section id="section-leave" class="space-y-4 hidden">
        <h2 class="text-xl font-semibold">Leave Request</h2>
        <p class="text-sm text-slate-500">
          Submit an off-day or annual leave request. Management can review and update the status.
        </p>

        <form id="leaveForm" class="space-y-4">
          <div class="grid sm:grid-cols-3 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">Leave type</label>
              <select
                id="leaveType"
                class="w-full border rounded-lg px-3 py-2 text-sm"
              >
                <option value="off-day">Off day</option>
                <option value="annual">Annual leave</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">Start date</label>
              <input
                id="leaveStart"
                type="date"
                required
                class="w-full border rounded-lg px-3 py-2 text-sm"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">End date</label>
              <input
                id="leaveEnd"
                type="date"
                required
                class="w-full border rounded-lg px-3 py-2 text-sm"
              />
            </div>
          </div>

          <button
            id="submitLeaveBtn"
            type="submit"
            class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 disabled:opacity-60"
          >
            Submit leave request
          </button>
        </form>

        <div id="leaveMessage" class="text-sm mt-2"></div>

        <div>
          <h3 class="text-sm font-semibold mt-4 mb-2">My requests</h3>
          <div id="myLeaveList" class="border rounded-2xl p-3 max-h-[260px] overflow-y-auto text-xs space-y-2"></div>
        </div>
      </section>

      <!-- AVAILABILITY SECTION -->
      <section id="section-availability" class="space-y-4 hidden">
        <h2 class="text-xl font-semibold">Leave Availability</h2>
        <p class="text-sm text-slate-500">
          Simple overview of approved leave so you can see who is off and when.
        </p>

        <div id="availabilityList" class="border rounded-2xl p-3 max-h-[420px] overflow-y-auto text-xs space-y-2"></div>
      </section>

    </main>
  </div>

  <!-- FIREBASE + APP LOGIC -->
  <script type="module">
    // Firebase imports from CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      where,
      orderBy,
      serverTimestamp,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ðŸ”§ REPLACE with your Firebase config
   const firebaseConfig = {
  apiKey: "AIzaSyCX44FHUpCQY-ma62m89rx3ah6s_gJtcY4",
  authDomain: "band-portal-8225e.firebaseapp.com",
  projectId: "band-portal-8225e",
  storageBucket: "band-portal-8225e.firebasestorage.app",
  messagingSenderId: "975187203610",
  appId: "1:975187203610:web:c044a2e0d3e2fd29b1e3a3"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // DOM elements
    const authArea = document.getElementById("authArea");
    const loginSection = document.getElementById("loginSection");
    const appSection = document.getElementById("appSection");
    const mainNav = document.getElementById("mainNav");
    const googleSignInBtn = document.getElementById("googleSignInBtn");

    const tabButtons = document.querySelectorAll(".tab-btn");
    const sections = {
      nominate: document.getElementById("section-nominate"),
      history: document.getElementById("section-history"),
      leave: document.getElementById("section-leave"),
      availability: document.getElementById("section-availability"),
    };

    let currentUser = null;

    // === AUTH ===
    googleSignInBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        alert("Login failed: " + err.message);
      }
    });

    async function handleSignOut() {
      await signOut(auth);
    }

    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;
      if (!user) {
        // Logged OUT
        authArea.innerHTML = "";
        loginSection.classList.remove("hidden");
        appSection.classList.add("hidden");
        mainNav.classList.add("hidden");
        return;
      }

      // Logged IN
      authArea.innerHTML = `
        <div class="text-xs text-slate-600">
          <div class="font-semibold">${user.displayName || "Logged in"}</div>
          <div class="">${user.email || ""}</div>
          <button id="logoutBtn" class="mt-1 inline-flex text-[11px] text-indigo-600 border border-indigo-200 rounded-full px-2 py-0.5 hover:bg-indigo-50">
            Sign out
          </button>
        </div>
      `;
      document.getElementById("logoutBtn").addEventListener("click", handleSignOut);

      loginSection.classList.add("hidden");
      appSection.classList.remove("hidden");
      mainNav.classList.remove("hidden");

      setDefaultMonth();
      switchSection("nominate");
      await loadHistory();
      await loadMyLeaveRequests();
      await loadAvailability();
    });

    // === TAB NAVIGATION ===
    function switchSection(key) {
      for (const name in sections) {
        sections[name].classList.toggle("hidden", name !== key);
      }
      tabButtons.forEach((btn) => {
        if (btn.dataset.section === key) {
          btn.classList.add("bg-white", "font-semibold");
        } else {
          btn.classList.remove("bg-white", "font-semibold");
        }
      });
    }

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const section = btn.dataset.section;
        switchSection(section);
        if (section === "history") loadHistory();
        if (section === "leave") loadMyLeaveRequests();
        if (section === "availability") loadAvailability();
      });
    });

    // === NOMINATION FORM ===
    const nominationForm = document.getElementById("nominationForm");
    const nomineeNameEl = document.getElementById("nomineeName");
    const nomineeDepartmentEl = document.getElementById("nomineeDepartment");
    const guestFeedbackPointsEl = document.getElementById("guestFeedbackPoints");
    const nominationMonthEl = document.getElementById("nominationMonth");
    const nominationReasonEl = document.getElementById("nominationReason");
    const nominationMessageEl = document.getElementById("nominationMessage");
    const submitNominationBtn = document.getElementById("submitNominationBtn");

    function setDefaultMonth() {
      const now = new Date();
      const value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
      nominationMonthEl.value = value;
    }

    setDefaultMonth();

    nominationForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) {
        alert("Please log in first.");
        return;
      }

      const nomineeName = nomineeNameEl.value.trim();
      const nomineeDepartment = nomineeDepartmentEl.value.trim();
      const guestFeedbackPoints = Number(guestFeedbackPointsEl.value || "0");
      const monthKey = nominationMonthEl.value || null;
      const reason = nominationReasonEl.value.trim();

      if (!nomineeName || !nomineeDepartment || !reason) {
        nominationMessageEl.textContent = "Please fill all required fields.";
        nominationMessageEl.className = "text-sm text-red-600";
        return;
      }

      submitNominationBtn.disabled = true;

      try {
        await addDoc(collection(db, "nominations"), {
          nomineeName,
          nomineeDepartment,
          guestFeedbackPoints,
          monthKey,
          reason,
          createdByUid: currentUser.uid,
          createdByName: currentUser.displayName || "",
          createdByEmail: currentUser.email || "",
          createdAt: serverTimestamp(),
        });

        nominationMessageEl.textContent = "Thank you! Your nomination has been submitted.";
        nominationMessageEl.className = "text-sm text-green-600";
        nominationForm.reset();
        setDefaultMonth();
        await loadHistory();
      } catch (err) {
        console.error(err);
        nominationMessageEl.textContent = "Something went wrong, please try again.";
        nominationMessageEl.className = "text-sm text-red-600";
      } finally {
        submitNominationBtn.disabled = false;
      }
    });

    // === NOMINATION HISTORY ===
    const historyList = document.getElementById("historyList");

    async function loadHistory() {
      historyList.innerHTML = '<div class="text-slate-400 text-xs">Loading nominations...</div>';
      try {
        // Simple query: order by createdAt (single field)
        const qNom = query(
          collection(db, "nominations"),
          orderBy("createdAt", "desc")
        );
        const snap = await getDocs(qNom);

        if (snap.empty) {
          historyList.innerHTML = '<div class="text-slate-400 text-xs">No nominations yet.</div>';
          return;
        }

        const items = [];
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          items.push(d);
        });

        historyList.innerHTML = "";
        items.forEach((d) => {
          const createdAtDate = d.createdAt?.toDate
            ? d.createdAt.toDate()
            : null;
          const dateStr = createdAtDate
            ? createdAtDate.toLocaleString()
            : "(date pending)";

          const div = document.createElement("div");
          div.className = "border rounded-xl p-2.5";
          div.innerHTML = `
            <div class="flex justify-between gap-2">
              <div>
                <div class="font-semibold text-sm">${d.nomineeName || ""}</div>
                <div class="text-[11px] text-slate-500">${d.nomineeDepartment || ""}</div>
              </div>
              <div class="text-[11px] text-amber-700 text-right">
                Guest feedback points:
                <span class="font-semibold">${d.guestFeedbackPoints || 0}</span>
                ${d.monthKey ? `<div>Month: ${d.monthKey}</div>` : ""}
              </div>
            </div>
            <div class="mt-2 text-xs text-slate-700 whitespace-pre-line">
              ${d.reason || ""}
            </div>
            <div class="mt-1 flex justify-between text-[11px] text-slate-400">
              <span>By: ${d.createdByName || ""} (${d.createdByEmail || ""})</span>
              <span>${dateStr}</span>
            </div>
          `;
          historyList.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        historyList.innerHTML =
          '<div class="text-red-500 text-xs">Failed to load nominations.</div>';
      }
    }

    // === LEAVE REQUESTS ===
    const leaveForm = document.getElementById("leaveForm");
    const leaveTypeEl = document.getElementById("leaveType");
    const leaveStartEl = document.getElementById("leaveStart");
    const leaveEndEl = document.getElementById("leaveEnd");
    const leaveMessageEl = document.getElementById("leaveMessage");
    const submitLeaveBtn = document.getElementById("submitLeaveBtn");
    const myLeaveList = document.getElementById("myLeaveList");

    leaveForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) {
        alert("Please log in first.");
        return;
      }

      const type = leaveTypeEl.value;
      const startDate = leaveStartEl.value;
      const endDate = leaveEndEl.value;

      if (!startDate || !endDate) {
        leaveMessageEl.textContent = "Please select start and end dates.";
        leaveMessageEl.className = "text-sm text-red-600";
        return;
      }
      if (endDate < startDate) {
        leaveMessageEl.textContent = "End date cannot be before start date.";
        leaveMessageEl.className = "text-sm text-red-600";
        return;
      }

      submitLeaveBtn.disabled = true;

      try {
        await addDoc(collection(db, "leaveRequests"), {
          userUid: currentUser.uid,
          userName: currentUser.displayName || "",
          userEmail: currentUser.email || "",
          type,
          startDate,
          endDate,
          status: "pending",
          createdAt: serverTimestamp(),
        });

        leaveMessageEl.textContent = "Your leave request has been submitted.";
        leaveMessageEl.className = "text-sm text-green-600";
        leaveForm.reset();
        await loadMyLeaveRequests();
        await loadAvailability();
      } catch (err) {
        console.error(err);
        leaveMessageEl.textContent =
          "Something went wrong while submitting your request.";
        leaveMessageEl.className = "text-sm text-red-600";
      } finally {
        submitLeaveBtn.disabled = false;
      }
    });

    async function loadMyLeaveRequests() {
      if (!currentUser) return;
      myLeaveList.innerHTML =
        '<div class="text-slate-400">Loading your requests...</div>';
      try {
        const qMy = query(
          collection(db, "leaveRequests"),
          where("userUid", "==", currentUser.uid)
        );
        const snap = await getDocs(qMy);

        if (snap.empty) {
          myLeaveList.innerHTML =
            '<div class="text-slate-400">No leave requests yet.</div>';
          return;
        }

        const rows = [];
        snap.forEach((docSnap) => rows.push(docSnap.data()));
        // Sort in JS by startDate
        rows.sort((a, b) => (a.startDate || "").localeCompare(b.startDate || ""));

        myLeaveList.innerHTML = "";
        rows.forEach((r) => {
          const div = document.createElement("div");
          div.className =
            "border rounded-xl px-2 py-1.5 flex justify-between items-center";
          div.innerHTML = `
            <div>
              <div class="font-semibold text-xs uppercase">${r.type}</div>
              <div class="text-[11px] text-slate-600">
                ${r.startDate} â†’ ${r.endDate}
              </div>
            </div>
            <div class="text-[11px] font-semibold ${
              r.status === "approved"
                ? "text-emerald-600"
                : r.status === "rejected"
                ? "text-red-600"
                : "text-amber-600"
            }">
              ${r.status}
            </div>
          `;
          myLeaveList.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        myLeaveList.innerHTML =
          '<div class="text-red-500">Failed to load your requests.</div>';
      }
    }

    // === AVAILABILITY (ALL APPROVED LEAVE) ===
    const availabilityList = document.getElementById("availabilityList");

    async function loadAvailability() {
      availabilityList.innerHTML =
        '<div class="text-slate-400">Loading approved leave...</div>';
      try {
        const qAll = query(
          collection(db, "leaveRequests"),
          where("status", "==", "approved")
        );
        const snap = await getDocs(qAll);

        if (snap.empty) {
          availabilityList.innerHTML =
            '<div class="text-slate-400">No approved leave yet.</div>';
          return;
        }

        const rows = [];
        snap.forEach((docSnap) => rows.push(docSnap.data()));
        // Sort by startDate locally
        rows.sort((a, b) => (a.startDate || "").localeCompare(b.startDate || ""));

        availabilityList.innerHTML = "";
        rows.forEach((r) => {
          const div = document.createElement("div");
          div.className = "border rounded-xl px-2 py-1.5";
          div.innerHTML = `
            <div class="flex justify-between">
              <div class="text-xs font-semibold">${r.userName || r.userEmail}</div>
              <div class="text-[11px] uppercase">${r.type}</div>
            </div>
            <div class="text-[11px] text-slate-600">
              ${r.startDate} â†’ ${r.endDate}
            </div>
          `;
          availabilityList.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        availabilityList.innerHTML =
          '<div class="text-red-500 text-xs">Failed to load availability.</div>';
      }
    }
  </script>
</body>
</html>
