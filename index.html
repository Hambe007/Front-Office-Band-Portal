<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Front Office Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: linear-gradient(
        180deg,
        #0ea5e9 0%,
        #38bdf8 26%,
        #67e8f9 52%,
        #e0f2fe 72%,
        #fefce8 100%
      );
      overflow-x: hidden;
    }

    /* Waves */
    .wave-wrapper {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 240px;
      z-index: 0;
      overflow: hidden;
      pointer-events: none;
    }
    .wave {
      position: absolute;
      bottom: 0;
      width: 200%;
      height: 100%;
      background-repeat: repeat-x;
      background-size: 50% 100%;
      animation: waveMove 18s linear infinite;
      opacity: 0.55;
      filter: blur(0.1px);
    }
    .wave.wave2 { animation-duration: 28s; opacity: 0.30; bottom: 14px; }
    .wave.wave3 { animation-duration: 40s; opacity: 0.18; bottom: 28px; }

    @keyframes waveMove {
      from { transform: translateX(0); }
      to   { transform: translateX(-50%); }
    }

    .content-layer { position: relative; z-index: 10; }

    /* Small UI polish */
    .chip { font-size: 11px; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(0,0,0,0.08); }
    .glass { background: rgba(255,255,255,0.88); backdrop-filter: blur(10px); }
    .btn { border-radius: 14px; padding: 10px 14px; font-weight: 700; font-size: 13px; }
    .btnPrimary { background: #4f46e5; color: white; }
    .btnPrimary:hover { background: #4338ca; }
    .btnGhost { background: rgba(255,255,255,0.75); border: 1px solid rgba(0,0,0,0.08); }
    .btnGhost:hover { background: rgba(255,255,255,0.95); }

    /* Tabs */
    .tab { padding: 9px 12px; border-radius: 14px; font-weight: 700; font-size: 13px; border: 1px solid rgba(0,0,0,0.08); background: rgba(255,255,255,0.65); }
    .tab.active { background: white; }
    .muted { color: rgba(15,23,42,0.65); }
  </style>
</head>

<body class="min-h-screen p-4 sm:p-8">
  <div class="content-layer mx-auto w-full max-w-6xl">
    <div class="glass shadow-xl rounded-3xl p-4 sm:p-6">

      <!-- Header -->
      <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <div>
          <h1 class="text-2xl font-black text-slate-900">Front Office Portal</h1>
          <p class="text-sm muted">Rocker nominations + Leave requests (Maldivian theme üåä)</p>
        </div>
        <div id="authArea"></div>
      </header>

      <!-- Login -->
      <section id="loginSection" class="mt-3">
        <div class="bg-white rounded-3xl border p-6 text-center">
          <h2 class="text-xl font-bold mb-2">Sign in to continue</h2>
          <p class="text-sm muted mb-4">Use your work Gmail to access nominations and leave requests.</p>
          <button id="googleSignInBtn" class="btn btnPrimary inline-flex items-center gap-2">
            Sign in with Google
          </button>
        </div>
      </section>

      <!-- Nav -->
      <nav id="mainNav" class="hidden my-4">
        <div class="flex flex-wrap gap-2">
          <button class="tab active" data-section="home">Home</button>
          <button class="tab" data-section="nominate">Nominate</button>
          <button class="tab" data-section="history">History</button>
          <button class="tab" data-section="leave">My Leave</button>
          <button class="tab hidden" data-admin-only="true" data-section="availability">Availability</button>
          <button class="tab hidden" data-admin-only="true" data-section="admin">Admin</button>
        </div>
      </nav>

      <!-- App -->
      <main id="appSection" class="hidden space-y-6">

        <!-- HOME -->
        <section id="section-home" class="space-y-4">
          <div class="bg-white rounded-3xl border p-4 sm:p-5">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <div class="flex items-center gap-3">
                <img id="profileImg" src="" alt="Profile" class="w-14 h-14 rounded-2xl object-cover border" />
                <div>
                  <div class="text-sm font-black" id="profileName">-</div>
                  <div class="text-xs muted" id="profileEmail">-</div>
                  <div class="mt-1 flex items-center gap-2">
                    <span id="roleChip" class="chip bg-slate-50 text-slate-700">Staff</span>
                    <span id="starsChip" class="chip bg-amber-50 text-amber-800">‚≠ê 0.0</span>
                  </div>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <label class="btn btnGhost cursor-pointer">
                  Upload Photo
                  <input id="photoInput" type="file" accept="image/*" class="hidden" />
                </label>
                <button id="logoutBtn" class="btn btnGhost">Sign out</button>
              </div>
            </div>

            <div class="mt-4 grid sm:grid-cols-3 gap-3">
              <div class="rounded-2xl bg-sky-50 border p-3">
                <div class="text-xs muted">Nominations open</div>
                <div class="text-sm font-black" id="nominationsOpenText">-</div>
              </div>
              <div class="rounded-2xl bg-sky-50 border p-3">
                <div class="text-xs muted">Closing date</div>
                <div class="text-sm font-black" id="closingDateText">-</div>
              </div>
              <div class="rounded-2xl bg-sky-50 border p-3">
                <div class="text-xs muted">Current month</div>
                <div class="text-sm font-black" id="currentMonthText">-</div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-3xl border p-4 sm:p-5">
            <div class="flex items-center justify-between gap-2 mb-2">
              <div>
                <h3 class="text-lg font-black">Top Nominations (This Month)</h3>
                <p class="text-xs muted">Ranked by number of nominations, then points.</p>
              </div>
              <button id="refreshTopBtn" class="btn btnGhost">Refresh</button>
            </div>
            <div id="topList" class="text-sm space-y-2"></div>
          </div>
        </section>

        <!-- NOMINATE -->
        <section id="section-nominate" class="hidden space-y-4">
          <div class="bg-white rounded-3xl border p-4 sm:p-5">
            <div class="flex flex-col sm:flex-row sm:justify-between gap-2">
              <div>
                <h2 class="text-xl font-black">Rocker Nomination</h2>
                <p class="text-sm muted">No duplicate nominations. Voting auto-closes end of month (or admin config).</p>
              </div>
              <div class="text-right">
                <div class="chip bg-slate-50 text-slate-700 inline-flex items-center gap-2">
                  <span>Month:</span> <span id="nomMonthBadge" class="font-black">-</span>
                </div>
              </div>
            </div>

            <div id="nominationClosedBanner" class="hidden mt-3 rounded-2xl border bg-rose-50 p-3 text-sm text-rose-800">
              Nominations are currently closed.
            </div>

            <form id="nominationForm" class="mt-4 space-y-4">
              <div class="grid sm:grid-cols-2 gap-3">
                <div>
                  <label class="text-sm font-bold">Nominee name</label>
                  <input id="nomineeName" class="w-full border rounded-2xl px-3 py-2 text-sm" placeholder="e.g. Faheel" required />
                </div>
                <div>
                  <label class="text-sm font-bold">Department</label>
                  <input id="nomineeDept" class="w-full border rounded-2xl px-3 py-2 text-sm" placeholder="Front Office" required />
                </div>
              </div>

              <div class="grid sm:grid-cols-2 gap-3">
                <div>
                  <label class="text-sm font-bold">Guest feedback points</label>
                  <select id="guestPoints" class="w-full border rounded-2xl px-3 py-2 text-sm">
                    <option value="0">0 ‚Äì No mentions</option>
                    <option value="5">5 ‚Äì Guest mentioned</option>
                    <option value="10">10 ‚Äì Strong recognition</option>
                    <option value="15">15 ‚Äì Outstanding</option>
                  </select>
                  <p class="text-[11px] muted mt-1">Adds extra weight for staff recognized by guests.</p>
                </div>
                <div>
                  <label class="text-sm font-bold">Nomination month</label>
                  <input id="nominationMonth" type="month" class="w-full border rounded-2xl px-3 py-2 text-sm" />
                </div>
              </div>

              <div>
                <label class="text-sm font-bold">Reason (required)</label>
                <textarea id="nominationReason" rows="4" class="w-full border rounded-2xl px-3 py-2 text-sm" placeholder="Explain what they did, guest feedback, teamwork, extra mile..." required></textarea>
              </div>

              <button id="submitNominationBtn" class="btn btnPrimary">Submit nomination</button>
              <div id="nominationMessage" class="text-sm mt-2"></div>
            </form>
          </div>
        </section>

        <!-- HISTORY -->
        <section id="section-history" class="hidden space-y-4">
          <div class="bg-white rounded-3xl border p-4 sm:p-5">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <div>
                <h2 class="text-xl font-black">Nomination History</h2>
                <p class="text-sm muted">Filter by month.</p>
              </div>
              <div class="flex items-center gap-2">
                <input id="historyMonth" type="month" class="border rounded-2xl px-3 py-2 text-sm" />
                <button id="historyLoadBtn" class="btn btnGhost">Load</button>
              </div>
            </div>

            <div id="historyList" class="mt-4 space-y-3 max-h-[520px] overflow-y-auto"></div>
          </div>
        </section>

        <!-- LEAVE -->
        <section id="section-leave" class="hidden space-y-4">
          <div class="bg-white rounded-3xl border p-4 sm:p-5">
            <h2 class="text-xl font-black">My Leave Requests</h2>
            <p class="text-sm muted">Reason is required. Admin can approve/reject with comment.</p>

            <form id="leaveForm" class="mt-4 space-y-4">
              <div class="grid sm:grid-cols-3 gap-3">
                <div>
                  <label class="text-sm font-bold">Leave type</label>
                  <select id="leaveType" class="w-full border rounded-2xl px-3 py-2 text-sm">
                    <option value="off-day">Off day</option>
                    <option value="annual">Annual leave</option>
                  </select>
                </div>
                <div>
                  <label class="text-sm font-bold">Start date</label>
                  <input id="leaveStart" type="date" required class="w-full border rounded-2xl px-3 py-2 text-sm" />
                </div>
                <div>
                  <label class="text-sm font-bold">End date</label>
                  <input id="leaveEnd" type="date" required class="w-full border rounded-2xl px-3 py-2 text-sm" />
                </div>
              </div>

              <div>
                <label class="text-sm font-bold">Reason (required)</label>
                <textarea id="leaveReason" rows="3" required class="w-full border rounded-2xl px-3 py-2 text-sm" placeholder="e.g. Family event / medical appointment / personal..."></textarea>
              </div>

              <button id="submitLeaveBtn" class="btn btnPrimary">Submit leave request</button>
              <div id="leaveMessage" class="text-sm mt-2"></div>
            </form>

            <div class="mt-6">
              <h3 class="text-sm font-black mb-2">My requests</h3>
              <div id="myLeaveList" class="space-y-2"></div>
            </div>
          </div>
        </section>

        <!-- AVAILABILITY -->
        <section id="section-availability" class="hidden space-y-4">
          <div class="bg-white rounded-3xl border p-4 sm:p-5">
            <h2 class="text-xl font-black">Leave Availability (Approved)</h2>
            <p class="text-sm muted">Admin-only view for operational planning.</p>
            <div id="availabilityList" class="mt-4 space-y-2"></div>
          </div>
        </section>

        <!-- ADMIN -->
        <section id="section-admin" class="hidden space-y-4">
          <div class="bg-white rounded-3xl border p-4 sm:p-5 space-y-4">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <div>
                <h2 class="text-xl font-black">Admin Panel</h2>
                <p class="text-sm muted">Manage nominations config + approve/reject leave with comments.</p>
              </div>
              <div class="chip bg-emerald-50 text-emerald-800">Super Admin</div>
            </div>

            <!-- Config -->
            <div class="rounded-2xl border bg-slate-50 p-4">
              <h3 class="text-sm font-black mb-2">Voting / Nominations Settings</h3>
              <div class="grid sm:grid-cols-3 gap-3">
                <div class="rounded-2xl bg-white border p-3">
                  <div class="text-xs muted mb-1">Nominations Open</div>
                  <select id="cfgOpen" class="w-full border rounded-2xl px-3 py-2 text-sm">
                    <option value="true">Open</option>
                    <option value="false">Closed</option>
                  </select>
                </div>
                <div class="rounded-2xl bg-white border p-3">
                  <div class="text-xs muted mb-1">Close at (date)</div>
                  <input id="cfgCloseAt" type="date" class="w-full border rounded-2xl px-3 py-2 text-sm" />
                </div>
                <div class="rounded-2xl bg-white border p-3">
                  <div class="text-xs muted mb-1">Allow Photo Upload</div>
                  <select id="cfgPhoto" class="w-full border rounded-2xl px-3 py-2 text-sm">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                  </select>
                </div>
              </div>
              <div class="mt-3 flex items-center gap-2">
                <button id="saveConfigBtn" class="btn btnPrimary">Save settings</button>
                <div id="configMsg" class="text-sm"></div>
              </div>
            </div>

            <!-- Leave approvals -->
            <div class="rounded-2xl border p-4">
              <h3 class="text-lg font-black mb-1">Leave Requests ‚Äì Approvals</h3>
              <p class="text-xs muted mb-3">Only admins can see all requests.</p>
              <div id="adminLeaveList" class="space-y-2"></div>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- Waves -->
  <div class="wave-wrapper">
    <div class="wave" style="background-image: url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 1440 320%22><path fill=%22%23ffffff%22 fill-opacity=%220.75%22 d=%22M0,224L60,213.3C120,203,240,181,360,170.7C480,160,600,160,720,181.3C840,203,960,245,1080,256C1200,267,1320,245,1380,234.7L1440,224L1440,320L0,320Z%22 /></svg>');"></div>
    <div class="wave wave2" style="background-image: url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 1440 320%22><path fill=%22%23ffffff%22 fill-opacity=%220.45%22 d=%22M0,256L80,240C160,224,320,192,480,181.3C640,171,800,181,960,192C1120,203,1280,213,1360,218.7L1440,224L1440,320L0,320Z%22 /></svg>');"></div>
    <div class="wave wave3" style="background-image: url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 1440 320%22><path fill=%22%23ffffff%22 fill-opacity=%220.25%22 d=%22M0,288L120,272C240,256,480,224,720,229.3C960,235,1200,277,1320,298.7L1440,320L1440,320L0,320Z%22 /></svg>');"></div>
  </div>

  <!-- Firebase App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      where,
      orderBy,
      serverTimestamp,
      doc,
      setDoc,
      getDoc,
      updateDoc,
      Timestamp,
      limit,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ‚úÖ Your Firebase config (from your earlier file)
    const firebaseConfig = {
      apiKey: "AIzaSyCX44FHUpCQY-ma62m89rx3ah6s_gJtcY4",
      authDomain: "band-portal-8225e.firebaseapp.com",
      projectId: "band-portal-8225e",
      storageBucket: "band-portal-8225e.firebasestorage.app",
      messagingSenderId: "975187203610",
      appId: "1:975187203610:web:c044a2e0d3e2fd29b1e3a3"
    };

    // ‚úÖ Super Admins
    const SUPER_ADMIN_EMAILS = [
      "hamid.bashyr@gmail.com",
      "eslamhzaki7@gmail.com",
    ];

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const storage = getStorage(app);

    // UI
    const qs = (id) => document.getElementById(id);
    const loginSection = qs("loginSection");
    const appSection = qs("appSection");
    const mainNav = qs("mainNav");
    const authArea = qs("authArea");
    const tabs = document.querySelectorAll(".tab");

    const sections = {
      home: qs("section-home"),
      nominate: qs("section-nominate"),
      history: qs("section-history"),
      leave: qs("section-leave"),
      availability: qs("section-availability"),
      admin: qs("section-admin"),
    };

    let currentUser = null;
    let isSuperAdmin = false;
    let appConfig = null;

    const CONFIG_DOC = doc(db, "config", "app"); // config/app

    function monthKeyFromDate(d = new Date()) {
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
    }

    function endOfMonthDate(d = new Date()) {
      return new Date(d.getFullYear(), d.getMonth() + 1, 0, 23, 59, 59);
    }

    function normalizeName(s) {
      return (s || "").trim().toLowerCase().replace(/\s+/g, " ");
    }

    function ratingFromCount(count) {
      // Simple: 0->0, 1->3.5, 2->3.8, 3->4.1, 4->4.3, 5->4.5, 6->4.6, 7->4.7, 8->4.8, 9->4.9, 10+->5.0
      if (!count) return 0.0;
      const table = [0, 3.5, 3.8, 4.1, 4.3, 4.5, 4.6, 4.7, 4.8, 4.9];
      return count >= 10 ? 5.0 : table[count];
    }

    function setTabActive(key) {
      tabs.forEach(t => t.classList.toggle("active", t.dataset.section === key));
      for (const k in sections) sections[k].classList.toggle("hidden", k !== key);
    }

    tabs.forEach(btn => {
      btn.addEventListener("click", async () => {
        const key = btn.dataset.section;
        setTabActive(key);
        if (key === "home") await loadTopNominations(monthKeyFromDate());
        if (key === "history") await loadHistory();
        if (key === "leave") await loadMyLeaveRequests();
        if (key === "availability" && isSuperAdmin) await loadAvailability();
        if (key === "admin" && isSuperAdmin) {
          await loadConfig();
          await loadAllLeaveRequests();
        }
      });
    });

    qs("googleSignInBtn").addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        alert("Login failed: " + err.message);
      }
    });

    async function handleSignOut() {
      await signOut(auth);
    }

    // Ensure config exists
    async function ensureConfig() {
      const snap = await getDoc(CONFIG_DOC);
      if (snap.exists()) return snap.data();

      const now = new Date();
      const defaultClose = endOfMonthDate(now);
      const data = {
        nominationsOpen: true,
        closeAt: Timestamp.fromDate(defaultClose),
        allowPhotoUpload: true,
        updatedAt: serverTimestamp(),
      };
      await setDoc(CONFIG_DOC, data, { merge: true });
      return data;
    }

    async function loadConfig() {
      appConfig = await ensureConfig();
      // admin UI
      if (isSuperAdmin) {
        qs("cfgOpen").value = String(!!appConfig.nominationsOpen);
        const closeAtDate = appConfig.closeAt?.toDate ? appConfig.closeAt.toDate() : endOfMonthDate(new Date());
        qs("cfgCloseAt").value = `${closeAtDate.getFullYear()}-${String(closeAtDate.getMonth()+1).padStart(2,"0")}-${String(closeAtDate.getDate()).padStart(2,"0")}`;
        qs("cfgPhoto").value = String(!!appConfig.allowPhotoUpload);
      }

      // home UI
      const now = new Date();
      const closeAt = appConfig.closeAt?.toDate ? appConfig.closeAt.toDate() : endOfMonthDate(now);
      const open = !!appConfig.nominationsOpen && now <= closeAt;
      qs("nominationsOpenText").textContent = open ? "Open ‚úÖ" : "Closed ‚ùå";
      qs("closingDateText").textContent = closeAt.toDateString();
      qs("currentMonthText").textContent = monthKeyFromDate(now);

      // nomination UI
      qs("nomMonthBadge").textContent = monthKeyFromDate(now);
      const closed = !open;
      qs("nominationClosedBanner").classList.toggle("hidden", !closed);
      qs("submitNominationBtn").disabled = closed;
      qs("submitNominationBtn").classList.toggle("opacity-60", closed);

      // photo upload allowed
      const canUpload = !!appConfig.allowPhotoUpload;
      qs("photoInput").disabled = !canUpload;
    }

    async function ensureUserProfile(user) {
      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);

      const base = {
        uid: user.uid,
        email: user.email || "",
        displayName: user.displayName || "",
        photoURL: user.photoURL || "",
        role: SUPER_ADMIN_EMAILS.includes(user.email) ? "admin" : "staff",
        updatedAt: serverTimestamp(),
      };

      if (!snap.exists()) {
        await setDoc(userRef, { ...base, createdAt: serverTimestamp() }, { merge: true });
      } else {
        await setDoc(userRef, base, { merge: true });
      }

      return userRef;
    }

    async function getUserProfile(uid) {
      const snap = await getDoc(doc(db, "users", uid));
      return snap.exists() ? snap.data() : null;
    }

    async function updateStarsForUser(uid, monthKey) {
      // Stars for staff based on number of nominations received in current month
      // We'll compute nominations where nomineeName matches profile displayName (best effort)
      const profile = await getUserProfile(uid);
      if (!profile) return;

      const displayName = normalizeName(profile.displayName);
      if (!displayName) return;

      const qNom = query(
        collection(db, "nominations"),
        where("monthKey", "==", monthKey),
        where("nomineeNameNorm", "==", displayName)
      );

      const snap = await getDocs(qNom);
      const count = snap.size;
      const rating = ratingFromCount(count);

      await setDoc(doc(db, "users", uid), { stars: rating, nominationsCount: count }, { merge: true });
    }

    function renderAuthUI(user, profile) {
      const role = isSuperAdmin ? "Super Admin" : "Staff";
      qs("profileName").textContent = profile?.displayName || user.displayName || "Logged in";
      qs("profileEmail").textContent = profile?.email || user.email || "";
      qs("roleChip").textContent = role;
      qs("roleChip").className = `chip ${isSuperAdmin ? "bg-emerald-50 text-emerald-800" : "bg-slate-50 text-slate-700"}`;

      const stars = Number(profile?.stars || 0).toFixed(1);
      qs("starsChip").textContent = `‚≠ê ${stars}`;

      const imgSrc = profile?.customPhotoURL || profile?.photoURL || user.photoURL || "https://via.placeholder.com/80";
      qs("profileImg").src = imgSrc;

      authArea.innerHTML = `
        <div class="text-right text-xs text-slate-700">
          <div class="font-black">${user.displayName || "Logged in"}</div>
          <div class="muted">${user.email || ""}</div>
          <button id="logoutBtnTop" class="mt-2 btn btnGhost">Sign out</button>
        </div>
      `;
      qs("logoutBtnTop").addEventListener("click", handleSignOut);
      qs("logoutBtn").addEventListener("click", handleSignOut);
    }

    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;
      isSuperAdmin = !!(user && SUPER_ADMIN_EMAILS.includes(user.email));

      if (!user) {
        authArea.innerHTML = "";
        loginSection.classList.remove("hidden");
        appSection.classList.add("hidden");
        mainNav.classList.add("hidden");
        return;
      }

      loginSection.classList.add("hidden");
      appSection.classList.remove("hidden");
      mainNav.classList.remove("hidden");

      // admin only tabs
      document.querySelectorAll("[data-admin-only='true']").forEach(el => {
        el.classList.toggle("hidden", !isSuperAdmin);
      });
      sections.availability.classList.toggle("hidden", !isSuperAdmin);
      sections.admin.classList.toggle("hidden", !isSuperAdmin);

      // Ensure config + profile
      await loadConfig();
      const userRef = await ensureUserProfile(user);
      const profile = await getUserProfile(user.uid);

      // Compute stars for user based on nominations received this month (best effort by displayName)
      await updateStarsForUser(user.uid, monthKeyFromDate());

      const profile2 = await getUserProfile(user.uid);
      renderAuthUI(user, profile2);

      // default tab
      setTabActive("home");
      qs("nominationMonth").value = monthKeyFromDate();
      qs("historyMonth").value = monthKeyFromDate();
      await loadTopNominations(monthKeyFromDate());
      await loadMyLeaveRequests();
      if (isSuperAdmin) {
        await loadAllLeaveRequests();
        await loadAvailability();
      }
    });

    // Photo upload
    qs("photoInput").addEventListener("change", async (e) => {
      try {
        if (!currentUser) return;
        if (!appConfig?.allowPhotoUpload) {
          alert("Photo upload is disabled by admin.");
          return;
        }

        const file = e.target.files?.[0];
        if (!file) return;

        const path = `profilePhotos/${currentUser.uid}/profile.jpg`;
        const r = ref(storage, path);
        await uploadBytes(r, file);
        const url = await getDownloadURL(r);

        await setDoc(doc(db, "users", currentUser.uid), { customPhotoURL: url, updatedAt: serverTimestamp() }, { merge: true });
        const profile = await getUserProfile(currentUser.uid);
        qs("profileImg").src = profile.customPhotoURL || profile.photoURL || currentUser.photoURL;
        alert("Profile photo updated ‚úÖ");
      } catch (err) {
        console.error(err);
        alert("Upload failed: " + err.message);
      } finally {
        qs("photoInput").value = "";
      }
    });

    // -------- Nominations --------
    const nominationForm = qs("nominationForm");
    const nominationMessageEl = qs("nominationMessage");

    function nominationsOpenNow() {
      const now = new Date();
      const closeAt = appConfig?.closeAt?.toDate ? appConfig.closeAt.toDate() : endOfMonthDate(now);
      const open = !!appConfig?.nominationsOpen && now <= closeAt;
      return open;
    }

    async function checkDuplicateNomination({ nomineeNameNorm, monthKey }) {
      const qDup = query(
        collection(db, "nominations"),
        where("monthKey", "==", monthKey),
        where("createdByUid", "==", currentUser.uid),
        where("nomineeNameNorm", "==", nomineeNameNorm),
        limit(1)
      );
      const snap = await getDocs(qDup);
      return !snap.empty;
    }

    nominationForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      if (!nominationsOpenNow()) {
        nominationMessageEl.textContent = "Nominations are closed.";
        nominationMessageEl.className = "text-sm text-rose-700";
        return;
      }

      const nomineeName = qs("nomineeName").value.trim();
      const nomineeDept = qs("nomineeDept").value.trim();
      const guestFeedbackPoints = Number(qs("guestPoints").value || "0");
      const monthKey = qs("nominationMonth").value || monthKeyFromDate();
      const reason = qs("nominationReason").value.trim();

      if (!nomineeName || !nomineeDept || !reason) {
        nominationMessageEl.textContent = "Please fill all fields.";
        nominationMessageEl.className = "text-sm text-rose-700";
        return;
      }

      const nomineeNameNorm = normalizeName(nomineeName);

      // Stop duplicates
      const isDup = await checkDuplicateNomination({ nomineeNameNorm, monthKey });
      if (isDup) {
        nominationMessageEl.textContent = "Duplicate blocked: You already nominated this person for this month.";
        nominationMessageEl.className = "text-sm text-rose-700";
        return;
      }

      qs("submitNominationBtn").disabled = true;

      try {
        await addDoc(collection(db, "nominations"), {
          nomineeName,
          nomineeNameNorm,
          nomineeDepartment: nomineeDept,
          guestFeedbackPoints,
          monthKey,
          reason,
          createdByUid: currentUser.uid,
          createdByName: currentUser.displayName || "",
          createdByEmail: currentUser.email || "",
          createdAt: serverTimestamp(),
        });

        nominationMessageEl.textContent = "Nomination submitted ‚úÖ";
        nominationMessageEl.className = "text-sm text-emerald-700";

        nominationForm.reset();
        qs("nominationMonth").value = monthKeyFromDate();
        qs("nomMonthBadge").textContent = monthKeyFromDate();
        await loadTopNominations(monthKeyFromDate());

      } catch (err) {
        console.error(err);
        nominationMessageEl.textContent = "Failed to submit. Try again.";
        nominationMessageEl.className = "text-sm text-rose-700";
      } finally {
        qs("submitNominationBtn").disabled = false;
      }
    });

    // History by month
    qs("historyLoadBtn").addEventListener("click", loadHistory);

    async function loadHistory() {
      const monthKey = qs("historyMonth").value || monthKeyFromDate();
      qs("historyList").innerHTML = `<div class="text-sm muted">Loading‚Ä¶</div>`;

      try {
        const qH = query(
          collection(db, "nominations"),
          where("monthKey", "==", monthKey),
          orderBy("createdAt", "desc")
        );
        const snap = await getDocs(qH);

        if (snap.empty) {
          qs("historyList").innerHTML = `<div class="text-sm muted">No nominations for ${monthKey}.</div>`;
          return;
        }

        const html = [];
        snap.forEach((d) => {
          const n = d.data();
          html.push(`
            <div class="bg-white rounded-2xl border p-3">
              <div class="flex justify-between gap-3">
                <div>
                  <div class="text-sm font-black">${n.nomineeName}</div>
                  <div class="text-xs muted">${n.nomineeDepartment}</div>
                </div>
                <div class="text-right">
                  <div class="chip bg-amber-50 text-amber-800">Points: <b>${n.guestFeedbackPoints || 0}</b></div>
                  <div class="text-[11px] muted mt-1">${n.monthKey}</div>
                </div>
              </div>
              <div class="mt-2 text-sm text-slate-800 whitespace-pre-line">${n.reason || ""}</div>
              <div class="mt-2 text-[11px] muted">By: ${n.createdByName || ""} (${n.createdByEmail || ""})</div>
            </div>
          `);
        });

        qs("historyList").innerHTML = html.join("");
      } catch (err) {
        console.error(err);
        qs("historyList").innerHTML = `<div class="text-sm text-rose-700">Failed to load history.</div>`;
      }
    }

    // Leaderboard / Top nominations (month)
    qs("refreshTopBtn").addEventListener("click", async () => loadTopNominations(monthKeyFromDate()));

    async function loadTopNominations(monthKey) {
      qs("topList").innerHTML = `<div class="text-sm muted">Loading‚Ä¶</div>`;

      try {
        const qN = query(
          collection(db, "nominations"),
          where("monthKey", "==", monthKey)
        );
        const snap = await getDocs(qN);

        if (snap.empty) {
          qs("topList").innerHTML = `<div class="text-sm muted">No nominations yet this month.</div>`;
          return;
        }

        const map = new Map();
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          const key = `${normalizeName(d.nomineeName)}||${normalizeName(d.nomineeDepartment)}`;
          const cur = map.get(key) || { nomineeName: d.nomineeName, dept: d.nomineeDepartment, count: 0, points: 0 };
          cur.count += 1;
          cur.points += Number(d.guestFeedbackPoints || 0);
          map.set(key, cur);
        });

        const rows = Array.from(map.values());
        rows.sort((a,b) => (b.count - a.count) || (b.points - a.points));

        const html = rows.slice(0, 10).map((r, i) => {
          const stars = ratingFromCount(r.count).toFixed(1);
          return `
            <div class="bg-white rounded-2xl border p-3 flex items-center justify-between gap-3">
              <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-2xl bg-sky-50 border flex items-center justify-center font-black">#${i+1}</div>
                <div>
                  <div class="text-sm font-black">${r.nomineeName}</div>
                  <div class="text-xs muted">${r.dept}</div>
                </div>
              </div>
              <div class="text-right">
                <div class="chip bg-emerald-50 text-emerald-800">Noms: <b>${r.count}</b></div>
                <div class="chip bg-amber-50 text-amber-800 mt-1">‚≠ê ${stars} ‚Ä¢ Points: <b>${r.points}</b></div>
              </div>
            </div>
          `;
        });

        qs("topList").innerHTML = html.join("");
      } catch (err) {
        console.error(err);
        qs("topList").innerHTML = `<div class="text-sm text-rose-700">Failed to load leaderboard.</div>`;
      }
    }

    // -------- Leave Requests --------
    qs("leaveForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const type = qs("leaveType").value;
      const startDate = qs("leaveStart").value;
      const endDate = qs("leaveEnd").value;
      const reason = (qs("leaveReason").value || "").trim();

      if (!startDate || !endDate) {
        qs("leaveMessage").textContent = "Please select start and end dates.";
        qs("leaveMessage").className = "text-sm text-rose-700";
        return;
      }
      if (endDate < startDate) {
        qs("leaveMessage").textContent = "End date cannot be before start date.";
        qs("leaveMessage").className = "text-sm text-rose-700";
        return;
      }
      if (!reason) {
        qs("leaveMessage").textContent = "Please enter a reason.";
        qs("leaveMessage").className = "text-sm text-rose-700";
        return;
      }

      qs("submitLeaveBtn").disabled = true;

      try {
        await addDoc(collection(db, "leaveRequests"), {
          userUid: currentUser.uid,
          userName: currentUser.displayName || "",
          userEmail: currentUser.email || "",
          type,
          startDate,
          endDate,
          reason,
          status: "pending",
          createdAt: serverTimestamp(),
        });

        qs("leaveMessage").textContent = "Leave request submitted ‚úÖ";
        qs("leaveMessage").className = "text-sm text-emerald-700";
        qs("leaveForm").reset();

        await loadMyLeaveRequests();
        if (isSuperAdmin) {
          await loadAllLeaveRequests();
          await loadAvailability();
        }
      } catch (err) {
        console.error(err);
        qs("leaveMessage").textContent = "Failed to submit leave request.";
        qs("leaveMessage").className = "text-sm text-rose-700";
      } finally {
        qs("submitLeaveBtn").disabled = false;
      }
    });

    async function loadMyLeaveRequests() {
      if (!currentUser) return;

      qs("myLeaveList").innerHTML = `<div class="text-sm muted">Loading‚Ä¶</div>`;

      try {
        const qMy = query(
          collection(db, "leaveRequests"),
          where("userUid", "==", currentUser.uid)
        );
        const snap = await getDocs(qMy);

        if (snap.empty) {
          qs("myLeaveList").innerHTML = `<div class="text-sm muted">No leave requests yet.</div>`;
          return;
        }

        const rows = [];
        snap.forEach((d) => rows.push({ id: d.id, ...d.data() }));
        rows.sort((a,b) => (a.startDate || "").localeCompare(b.startDate || ""));

        qs("myLeaveList").innerHTML = rows.map(r => {
          const statusClass =
            r.status === "approved" ? "text-emerald-700" :
            r.status === "rejected" ? "text-rose-700" : "text-amber-700";

          return `
            <div class="bg-white rounded-2xl border p-3">
              <div class="flex justify-between items-start gap-3">
                <div>
                  <div class="text-sm font-black uppercase">${r.type}</div>
                  <div class="text-xs muted">${r.startDate} ‚Üí ${r.endDate}</div>
                  <div class="text-xs mt-1"><span class="muted">Reason:</span> ${r.reason || "-"}</div>
                  ${r.status === "rejected" && r.rejectionReason ? `
                    <div class="text-xs mt-1 text-rose-700"><b>Rejected comment:</b> ${r.rejectionReason}</div>
                  ` : ""}
                </div>
                <div class="chip bg-slate-50 ${statusClass}"><b>${r.status}</b></div>
              </div>
            </div>
          `;
        }).join("");
      } catch (err) {
        console.error(err);
        qs("myLeaveList").innerHTML = `<div class="text-sm text-rose-700">Failed to load your leave.</div>`;
      }
    }

    // Admin leave list
    async function loadAllLeaveRequests() {
      if (!isSuperAdmin) return;

      qs("adminLeaveList").innerHTML = `<div class="text-sm muted">Loading‚Ä¶</div>`;

      try {
        const qAll = query(collection(db, "leaveRequests"), orderBy("createdAt", "desc"));
        const snap = await getDocs(qAll);

        if (snap.empty) {
          qs("adminLeaveList").innerHTML = `<div class="text-sm muted">No requests yet.</div>`;
          return;
        }

        const rows = [];
        snap.forEach(d => rows.push({ id: d.id, ...d.data() }));

        qs("adminLeaveList").innerHTML = rows.map(r => {
          const statusClass =
            r.status === "approved" ? "text-emerald-700" :
            r.status === "rejected" ? "text-rose-700" : "text-amber-700";

          const actions = r.status === "pending" ? `
            <div class="flex gap-2">
              <button class="btn btnPrimary py-2 px-3" data-act="approve" data-id="${r.id}">Approve</button>
              <button class="btn btnGhost py-2 px-3" data-act="reject" data-id="${r.id}">Reject</button>
            </div>
          ` : "";

          return `
            <div class="bg-white rounded-2xl border p-3">
              <div class="flex justify-between gap-3">
                <div>
                  <div class="text-sm font-black">${r.userName || r.userEmail}</div>
                  <div class="text-xs muted">${(r.type || "").toUpperCase()} ‚Ä¢ ${r.startDate} ‚Üí ${r.endDate}</div>
                  <div class="text-xs mt-1"><span class="muted">Reason:</span> ${r.reason || "-"}</div>
                  ${r.status === "rejected" && r.rejectionReason ? `<div class="text-xs text-rose-700 mt-1"><b>Comment:</b> ${r.rejectionReason}</div>` : ""}
                </div>
                <div class="text-right">
                  <div class="chip bg-slate-50 ${statusClass}"><b>${r.status}</b></div>
                  <div class="mt-2">${actions}</div>
                </div>
              </div>
            </div>
          `;
        }).join("");

        // Bind action buttons
        qs("adminLeaveList").querySelectorAll("button[data-act]").forEach(btn => {
          const id = btn.dataset.id;
          const act = btn.dataset.act;

          btn.addEventListener("click", async () => {
            if (act === "approve") {
              await updateDoc(doc(db, "leaveRequests", id), {
                status: "approved",
                rejectionReason: "",
                reviewedBy: currentUser?.email || "",
                reviewedAt: serverTimestamp(),
              });
              await loadAllLeaveRequests();
              await loadAvailability();
              await loadMyLeaveRequests();
            } else {
              const comment = prompt("Rejection comment (required, will be emailed):");
              if (!comment || !comment.trim()) {
                alert("Rejection comment is required.");
                return;
              }
              await updateDoc(doc(db, "leaveRequests", id), {
                status: "rejected",
                rejectionReason: comment.trim(),
                reviewedBy: currentUser?.email || "",
                reviewedAt: serverTimestamp(),
              });
              await loadAllLeaveRequests();
              await loadAvailability();
              await loadMyLeaveRequests();
            }
          });
        });

      } catch (err) {
        console.error(err);
        qs("adminLeaveList").innerHTML = `<div class="text-sm text-rose-700">Failed to load admin requests.</div>`;
      }
    }

    async function loadAvailability() {
      if (!isSuperAdmin) return;
      qs("availabilityList").innerHTML = `<div class="text-sm muted">Loading‚Ä¶</div>`;

      try {
        const qApp = query(collection(db, "leaveRequests"), where("status", "==", "approved"));
        const snap = await getDocs(qApp);

        if (snap.empty) {
          qs("availabilityList").innerHTML = `<div class="text-sm muted">No approved leave yet.</div>`;
          return;
        }

        const rows = [];
        snap.forEach(d => rows.push(d.data()));
        rows.sort((a,b) => (a.startDate || "").localeCompare(b.startDate || ""));

        qs("availabilityList").innerHTML = rows.map(r => `
          <div class="bg-white rounded-2xl border p-3">
            <div class="flex justify-between">
              <div class="text-sm font-black">${r.userName || r.userEmail}</div>
              <div class="chip bg-slate-50 text-slate-700 uppercase">${r.type}</div>
            </div>
            <div class="text-xs muted">${r.startDate} ‚Üí ${r.endDate}</div>
          </div>
        `).join("");

      } catch (err) {
        console.error(err);
        qs("availabilityList").innerHTML = `<div class="text-sm text-rose-700">Failed to load availability.</div>`;
      }
    }

    // Admin Config save
    qs("saveConfigBtn").addEventListener("click", async () => {
      if (!isSuperAdmin) return;

      try {
        const nominationsOpen = qs("cfgOpen").value === "true";
        const closeAtDateStr = qs("cfgCloseAt").value;
        const allowPhotoUpload = qs("cfgPhoto").value === "true";

        const closeAt = closeAtDateStr
          ? Timestamp.fromDate(new Date(closeAtDateStr + "T23:59:59"))
          : Timestamp.fromDate(endOfMonthDate(new Date()));

        await setDoc(CONFIG_DOC, {
          nominationsOpen,
          closeAt,
          allowPhotoUpload,
          updatedAt: serverTimestamp(),
          updatedBy: currentUser?.email || "",
        }, { merge: true });

        qs("configMsg").textContent = "Saved ‚úÖ";
        qs("configMsg").className = "text-sm text-emerald-700";
        await loadConfig();
      } catch (err) {
        console.error(err);
        qs("configMsg").textContent = "Save failed.";
        qs("configMsg").className = "text-sm text-rose-700";
      }
    });

    // Initial month fields defaults
    const now = new Date();
    qs("nominationMonth").value = monthKeyFromDate(now);
    qs("historyMonth").value = monthKeyFromDate(now);

  </script>
</body>
</html>
