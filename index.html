<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Front Office Portal – Rocker of the Month & Leave Request</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-50">
  <!-- Maldivian theme background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-b from-sky-100 via-cyan-50 to-emerald-50"></div>
    <div class="absolute -top-24 -left-24 w-96 h-96 rounded-full bg-cyan-200/40 blur-3xl"></div>
    <div class="absolute top-40 -right-24 w-[28rem] h-[28rem] rounded-full bg-emerald-200/35 blur-3xl"></div>
    <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-[60rem] h-64 bg-sky-200/20 blur-2xl"></div>
  </div>

  <div class="min-h-screen flex items-center justify-center px-3 py-10">
    <div class="w-full max-w-6xl bg-white/85 backdrop-blur shadow-xl rounded-2xl p-4 sm:p-6">

      <!-- HEADER -->
      <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-500 to-emerald-500 text-white flex items-center justify-center font-black">
            FO
          </div>
          <div>
            <h1 class="text-2xl font-bold text-slate-900">Front Office Portal</h1>
            <p class="text-sm text-slate-600">Rocker of the Month • Leave Requests • Simple & Fast</p>
          </div>
        </div>

        <div id="authArea" class="text-right"></div>
      </header>

      <!-- NAV -->
      <nav id="mainNav" class="mb-4 hidden">
        <div class="inline-flex rounded-xl border border-slate-200 bg-white overflow-hidden text-sm shadow-sm">
          <button data-section="nominate" class="tab-btn px-3 py-2 font-semibold bg-slate-50">
            Nominate
          </button>
          <button data-section="history" class="tab-btn px-3 py-2">
            Nomination History
          </button>
          <button data-section="leave" class="tab-btn px-3 py-2">
            My Leave
          </button>
          <button data-section="availability" data-admin-only="true" class="tab-btn px-3 py-2 hidden">
            Leave Availability
          </button>
          <button data-section="admin" data-admin-only="true" class="tab-btn px-3 py-2 hidden">
            Admin
          </button>
        </div>
      </nav>

      <!-- LOGIN SECTION -->
      <section id="loginSection" class="mt-4">
        <div class="border border-slate-200 rounded-2xl p-8 text-center bg-white shadow-sm">
          <h2 class="text-xl font-semibold mb-2">Sign in to continue</h2>
          <p class="text-sm text-slate-600 mb-5">
            Please sign in with Google to submit nominations and leave requests.
          </p>

          <button
            id="googleSignInBtn"
            class="inline-flex items-center justify-center gap-2 px-5 py-2.5 rounded-xl bg-slate-900 text-white text-sm font-semibold hover:bg-black"
          >
            Sign in with Google
          </button>

          <p class="text-xs text-slate-500 mt-4">
            Tip: If you see “unauthorized domain”, add your domain in Firebase Auth → Authorized domains.
          </p>
        </div>
      </section>

      <!-- MAIN APP -->
      <main id="appSection" class="hidden">

        <!-- NOMINATION FORM -->
        <section id="section-nominate" class="space-y-5">
          <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
            <div>
              <h2 class="text-xl font-semibold">Rocker of the Month Nomination</h2>
              <p class="text-sm text-slate-600">
                Nominate a teammate and explain why. One nomination per nominee per month (per staff).
              </p>
            </div>
            <div class="text-xs text-slate-600">
              <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-slate-200 bg-white">
                <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                Voting open: <span id="votingStatusText" class="font-semibold">Checking…</span>
              </span>
            </div>
          </div>

          <form id="nominationForm" class="space-y-4 bg-white border border-slate-200 rounded-2xl p-4 sm:p-5 shadow-sm">
            <div class="grid sm:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1">Nominee name</label>
                <input
                  id="nomineeName"
                  type="text"
                  required
                  class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white"
                  placeholder="e.g. Faheel"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Nominee department</label>
                <input
                  id="nomineeDepartment"
                  type="text"
                  required
                  class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white"
                  placeholder="e.g. Front Office"
                />
              </div>
            </div>

            <div class="grid sm:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1">Guest feedback recognition points</label>
                <select id="guestFeedbackPoints" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white">
                  <option value="0">0 – No guest comments yet</option>
                  <option value="5">5 – Some guest mentions</option>
                  <option value="10">10 – Frequent guest recognition</option>
                  <option value="15">15 – Outstanding performance</option>
                </select>
                <p class="text-[11px] text-slate-500 mt-1">Admins can adjust with MOD based on actual guest reviews.</p>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">Nomination month</label>
                <input id="nominationMonth" type="month" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white" />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">Why are you nominating this person?</label>
              <textarea
                id="nominationReason"
                rows="4"
                required
                class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white"
                placeholder="Describe real examples: guest feedback, teamwork, attitude, going extra mile..."
              ></textarea>
            </div>

            <button
              id="submitNominationBtn"
              type="submit"
              class="px-4 py-2 rounded-xl bg-gradient-to-r from-cyan-600 to-emerald-600 text-white text-sm font-semibold hover:opacity-95 disabled:opacity-60"
            >
              Submit nomination
            </button>

            <div id="nominationMessage" class="text-sm"></div>
          </form>
        </section>

        <!-- NOMINATION HISTORY -->
        <section id="section-history" class="space-y-4 hidden">
          <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
            <div>
              <h2 class="text-xl font-semibold">Nomination History</h2>
              <p class="text-sm text-slate-600">Filter by month to view nominations.</p>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-xs text-slate-600">Month</label>
              <input id="historyMonth" type="month" class="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white" />
              <button id="refreshHistoryBtn" class="px-3 py-2 rounded-lg border border-slate-200 text-sm bg-white hover:bg-slate-50">
                Apply
              </button>
            </div>
          </div>

          <div class="border border-slate-200 rounded-2xl p-3 bg-white shadow-sm max-h-[480px] overflow-y-auto">
            <div id="historyList" class="space-y-3 text-sm"></div>
          </div>
        </section>

        <!-- MY LEAVE -->
        <section id="section-leave" class="space-y-4 hidden">
          <h2 class="text-xl font-semibold">My Leave Requests</h2>
          <p class="text-sm text-slate-600">
            Submit off-day or annual leave. Management will review and update status.
          </p>

          <form id="leaveForm" class="space-y-4 bg-white border border-slate-200 rounded-2xl p-4 sm:p-5 shadow-sm">
            <div class="grid sm:grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1">Leave type</label>
                <select id="leaveType" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white">
                  <option value="off-day">Off day</option>
                  <option value="annual">Annual leave</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">Start date</label>
                <input id="leaveStart" type="date" required class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white" />
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">End date</label>
                <input id="leaveEnd" type="date" required class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white" />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">Reason</label>
              <input id="leaveReason" type="text" required class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white"
                     placeholder="e.g. Family event / appointment / rest day" />
            </div>

            <button
              id="submitLeaveBtn"
              type="submit"
              class="px-4 py-2 rounded-xl bg-gradient-to-r from-cyan-600 to-emerald-600 text-white text-sm font-semibold hover:opacity-95 disabled:opacity-60"
            >
              Submit leave request
            </button>

            <div id="leaveMessage" class="text-sm mt-1"></div>
          </form>

          <div>
            <h3 class="text-sm font-semibold mt-4 mb-2">My requests</h3>
            <div id="myLeaveList" class="border border-slate-200 rounded-2xl p-3 bg-white shadow-sm max-h-[300px] overflow-y-auto text-xs space-y-2"></div>
          </div>
        </section>

        <!-- AVAILABILITY (ADMIN ONLY) -->
        <section id="section-availability" class="space-y-4 hidden">
          <h2 class="text-xl font-semibold">Leave Availability (Approved)</h2>
          <p class="text-sm text-slate-600">Overview of approved leave to help plan the operation.</p>

          <div id="availabilityList" class="border border-slate-200 rounded-2xl p-3 bg-white shadow-sm max-h-[480px] overflow-y-auto text-xs space-y-2"></div>
        </section>

        <!-- ADMIN -->
        <section id="section-admin" class="space-y-6 hidden">
          <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
            <div>
              <h2 class="text-xl font-semibold">Admin Panel</h2>
              <p class="text-sm text-slate-600">Approvals + Top nominations + Voting config</p>
            </div>
          </div>

          <!-- Voting config -->
          <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
            <h3 class="text-lg font-semibold mb-1">Voting Settings</h3>
            <p class="text-xs text-slate-600 mb-3">
              By default voting closes automatically at month end. You can override here.
            </p>

            <div class="grid sm:grid-cols-3 gap-3">
              <div class="sm:col-span-1">
                <label class="text-sm font-medium block mb-1">Override status</label>
                <select id="votingOverride" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white">
                  <option value="auto">Auto (month end)</option>
                  <option value="open">Force Open</option>
                  <option value="closed">Force Closed</option>
                </select>
              </div>

              <div class="sm:col-span-2">
                <label class="text-sm font-medium block mb-1">Message (optional)</label>
                <input id="votingMessage" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white"
                       placeholder="e.g. Voting closed for month-end processing." />
              </div>
            </div>

            <div class="mt-3 flex items-center gap-2">
              <button id="saveVotingConfigBtn" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm font-semibold hover:bg-black">
                Save config
              </button>
              <span id="configSavedMsg" class="text-xs text-slate-600"></span>
            </div>
          </div>

          <!-- Leave approvals -->
          <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
            <h3 class="text-lg font-semibold mb-1">Leave Requests – Approvals</h3>
            <p class="text-xs text-slate-600 mb-2">Approve or reject pending requests. Rejection requires a comment.</p>
            <div id="adminLeaveList" class="border border-slate-200 rounded-xl p-3 max-h-[360px] overflow-y-auto text-xs space-y-2"></div>
          </div>

          <!-- Top nominations -->
          <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
            <h3 class="text-lg font-semibold mb-1">Top Nominations</h3>
            <p class="text-xs text-slate-600 mb-2">Ranked by number of nominations, then guest feedback points.</p>
            <div id="topNominationsList" class="border border-slate-200 rounded-xl p-3 max-h-[360px] overflow-y-auto text-xs"></div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- FIREBASE & APP LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      getDoc,
      query,
      where,
      orderBy,
      serverTimestamp,
      doc,
      updateDoc,
      setDoc,
      limit,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithRedirect,
      getRedirectResult,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ✅ Your Firebase config (unchanged)
    const firebaseConfig = {
      apiKey: "AIzaSyCX44FHUpCQY-ma62m89rx3ah6s_gJtcY4",
      authDomain: "band-portal-8225e.firebaseapp.com",
      projectId: "band-portal-8225e",
      storageBucket: "band-portal-8225e.firebasestorage.app",
      messagingSenderId: "975187203610",
      appId: "1:975187203610:web:c044a2e0d3e2fd29b1e3a3"
    };

    // ✅ Set your super admin Gmail addresses here
    const SUPER_ADMIN_EMAILS = [
      "hamid.bashyr@gmail.com",
      "eslamhzaki7@gmail.com",
    ];

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // UI refs
    const authArea = document.getElementById("authArea");
    const loginSection = document.getElementById("loginSection");
    const appSection = document.getElementById("appSection");
    const mainNav = document.getElementById("mainNav");
    const googleSignInBtn = document.getElementById("googleSignInBtn");
    const tabButtons = document.querySelectorAll(".tab-btn");

    const sections = {
      nominate: document.getElementById("section-nominate"),
      history: document.getElementById("section-history"),
      leave: document.getElementById("section-leave"),
      availability: document.getElementById("section-availability"),
      admin: document.getElementById("section-admin"),
    };

    // Nomination refs
    const nominationForm = document.getElementById("nominationForm");
    const nomineeNameEl = document.getElementById("nomineeName");
    const nomineeDepartmentEl = document.getElementById("nomineeDepartment");
    const guestFeedbackPointsEl = document.getElementById("guestFeedbackPoints");
    const nominationMonthEl = document.getElementById("nominationMonth");
    const nominationReasonEl = document.getElementById("nominationReason");
    const nominationMessageEl = document.getElementById("nominationMessage");
    const submitNominationBtn = document.getElementById("submitNominationBtn");
    const historyList = document.getElementById("historyList");

    // History filter
    const historyMonthEl = document.getElementById("historyMonth");
    const refreshHistoryBtn = document.getElementById("refreshHistoryBtn");

    // Leave refs
    const leaveForm = document.getElementById("leaveForm");
    const leaveTypeEl = document.getElementById("leaveType");
    const leaveStartEl = document.getElementById("leaveStart");
    const leaveEndEl = document.getElementById("leaveEnd");
    const leaveReasonEl = document.getElementById("leaveReason");
    const leaveMessageEl = document.getElementById("leaveMessage");
    const submitLeaveBtn = document.getElementById("submitLeaveBtn");
    const myLeaveList = document.getElementById("myLeaveList");
    const availabilityList = document.getElementById("availabilityList");
    const adminLeaveList = document.getElementById("adminLeaveList");
    const topNominationsList = document.getElementById("topNominationsList");

    // Admin voting config
    const votingStatusText = document.getElementById("votingStatusText");
    const votingOverrideEl = document.getElementById("votingOverride");
    const votingMessageEl = document.getElementById("votingMessage");
    const saveVotingConfigBtn = document.getElementById("saveVotingConfigBtn");
    const configSavedMsg = document.getElementById("configSavedMsg");

    // State
    let currentUser = null;
    let isSuperAdmin = false;
    let votingOpen = true;
    let votingNote = "";

    // ---------- Helpers ----------
    function monthKeyDefault() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
    }

    function setDefaultMonths() {
      const m = monthKeyDefault();
      nominationMonthEl.value = m;
      historyMonthEl.value = m;
    }

    function switchSection(key) {
      for (const name in sections) {
        sections[name].classList.toggle("hidden", name !== key);
      }
      tabButtons.forEach((btn) => {
        if (btn.dataset.section === key) {
          btn.classList.add("bg-slate-50", "font-semibold");
        } else {
          btn.classList.remove("bg-slate-50", "font-semibold");
        }
      });
    }

    function endOfMonthClosed(monthKey) {
      // If monthKey is current month, voting is open until last day 23:59:59
      const [y, m] = monthKey.split("-").map(Number);
      const now = new Date();

      const lastDay = new Date(y, m, 0, 23, 59, 59, 999); // month is 1-based in our key
      return now > lastDay;
    }

    async function loadVotingConfig() {
      // Doc: config/voting
      const ref = doc(db, "config", "voting");
      const snap = await getDoc(ref);

      // Defaults
      let override = "auto";
      let message = "";

      if (snap.exists()) {
        const d = snap.data();
        override = d.override || "auto";
        message = d.message || "";
      }

      votingNote = message;

      const currentMonth = monthKeyDefault();
      const autoClosed = endOfMonthClosed(currentMonth);

      if (override === "open") votingOpen = true;
      else if (override === "closed") votingOpen = false;
      else votingOpen = !autoClosed;

      votingStatusText.textContent = votingOpen ? "OPEN" : "CLOSED";
      votingStatusText.className = votingOpen ? "font-semibold text-emerald-700" : "font-semibold text-red-700";

      // If admin, reflect config UI
      if (isSuperAdmin && votingOverrideEl) {
        votingOverrideEl.value = override;
        votingMessageEl.value = message;
      }

      // Disable nomination button when closed
      submitNominationBtn.disabled = !votingOpen;
      if (!votingOpen && message) {
        nominationMessageEl.textContent = message;
        nominationMessageEl.className = "text-sm text-red-600";
      } else if (!votingOpen) {
        nominationMessageEl.textContent = "Voting is closed for this month.";
        nominationMessageEl.className = "text-sm text-red-600";
      } else {
        nominationMessageEl.textContent = "";
      }
    }

    // ---------- AUTH (Redirect, reliable on GitHub Pages) ----------
    googleSignInBtn.addEventListener("click", () => {
      signInWithRedirect(auth, provider);
    });

    // handle redirect result
    getRedirectResult(auth).catch((err) => {
      console.error("Redirect error:", err);
      alert("Login failed: " + err.message);
    });

    async function handleSignOut() {
      await signOut(auth);
    }

    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;
      isSuperAdmin = !!(user && SUPER_ADMIN_EMAILS.includes(user.email));

      if (!user) {
        authArea.innerHTML = "";
        loginSection.classList.remove("hidden");
        appSection.classList.add("hidden");
        mainNav.classList.add("hidden");
        return;
      }

      authArea.innerHTML = `
        <div class="text-xs text-slate-700">
          <div class="font-semibold">${user.displayName || "Logged in"}</div>
          <div>${user.email || ""}</div>
          <div class="mt-1">
            <span class="inline-flex items-center rounded-full border px-2 py-0.5 text-[11px] ${
              isSuperAdmin ? "border-emerald-300 text-emerald-700 bg-emerald-50" : "border-slate-200 text-slate-600 bg-white"
            }">
              ${isSuperAdmin ? "Super Admin" : "Staff"}
            </span>
          </div>
          <button id="logoutBtn" class="mt-2 inline-flex text-[11px] text-slate-900 border border-slate-200 rounded-full px-2 py-0.5 hover:bg-slate-50">
            Sign out
          </button>
        </div>
      `;
      document.getElementById("logoutBtn").addEventListener("click", handleSignOut);

      loginSection.classList.add("hidden");
      appSection.classList.remove("hidden");
      mainNav.classList.remove("hidden");

      // Show/hide admin-only tabs
      document.querySelectorAll("[data-admin-only='true']").forEach((el) => {
        el.classList.toggle("hidden", !isSuperAdmin);
      });

      // default month values
      setDefaultMonths();
      switchSection("nominate");

      // Load config & data
      await loadVotingConfig();
      await loadHistory(historyMonthEl.value);
      await loadMyLeaveRequests();

      if (isSuperAdmin) {
        await loadAvailability();
        await loadAllLeaveRequests();
        await loadTopNominations();
      }
    });

    // Tabs
    tabButtons.forEach((btn) => {
      btn.addEventListener("click", async () => {
        const section = btn.dataset.section;
        switchSection(section);

        if (section === "nominate") {
          await loadVotingConfig();
        }
        if (section === "history") {
          await loadHistory(historyMonthEl.value);
        }
        if (section === "leave") {
          await loadMyLeaveRequests();
        }
        if (section === "availability" && isSuperAdmin) {
          await loadAvailability();
        }
        if (section === "admin" && isSuperAdmin) {
          await loadVotingConfig();
          await loadAllLeaveRequests();
          await loadTopNominations();
        }
      });
    });

    // ---------- Admin: save voting config ----------
    if (saveVotingConfigBtn) {
      saveVotingConfigBtn.addEventListener("click", async () => {
        if (!isSuperAdmin) return;
        configSavedMsg.textContent = "Saving...";
        try {
          await setDoc(doc(db, "config", "voting"), {
            override: votingOverrideEl.value,
            message: votingMessageEl.value.trim(),
            updatedAt: serverTimestamp(),
            updatedBy: currentUser?.email || "",
          }, { merge: true });

          configSavedMsg.textContent = "Saved ✅";
          setTimeout(() => (configSavedMsg.textContent = ""), 2000);
          await loadVotingConfig();
        } catch (e) {
          console.error(e);
          configSavedMsg.textContent = "Save failed ❌";
        }
      });
    }

    // ---------- NOMINATIONS ----------
    function normalizeName(s) {
      return (s || "").trim().toLowerCase().replace(/\s+/g, " ");
    }

    nominationForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) {
        alert("Please log in first.");
        return;
      }

      const nomineeName = nomineeNameEl.value.trim();
      const nomineeDepartment = nomineeDepartmentEl.value.trim();
      const guestFeedbackPoints = Number(guestFeedbackPointsEl.value || "0");
      const monthKey = nominationMonthEl.value || monthKeyDefault();
      const reason = nominationReasonEl.value.trim();

      if (!votingOpen) {
        nominationMessageEl.textContent = votingNote || "Voting is closed for this month.";
        nominationMessageEl.className = "text-sm text-red-600";
        return;
      }

      if (!nomineeName || !nomineeDepartment || !reason) {
        nominationMessageEl.textContent = "Please fill all required fields.";
        nominationMessageEl.className = "text-sm text-red-600";
        return;
      }

      // Duplicate protection: one nomination per nominee per user per month
      // (We query nominations where createdByUid + monthKey + nomineeNameKey)
      const nomineeNameKey = normalizeName(nomineeName);

      submitNominationBtn.disabled = true;
      nominationMessageEl.textContent = "Submitting...";
      nominationMessageEl.className = "text-sm text-slate-600";

      try {
        const qDup = query(
          collection(db, "nominations"),
          where("createdByUid", "==", currentUser.uid),
          where("monthKey", "==", monthKey),
          where("nomineeNameKey", "==", nomineeNameKey),
          limit(1)
        );
        const dupSnap = await getDocs(qDup);

        if (!dupSnap.empty) {
          nominationMessageEl.textContent = "You already nominated this person for this month.";
          nominationMessageEl.className = "text-sm text-amber-700";
          submitNominationBtn.disabled = false;
          return;
        }

        await addDoc(collection(db, "nominations"), {
          nomineeName,
          nomineeNameKey,
          nomineeDepartment,
          guestFeedbackPoints,
          monthKey,
          reason,
          createdByUid: currentUser.uid,
          createdByName: currentUser.displayName || "",
          createdByEmail: currentUser.email || "",
          createdAt: serverTimestamp(),
        });

        nominationMessageEl.textContent = "Thank you! Your nomination has been submitted.";
        nominationMessageEl.className = "text-sm text-emerald-700";
        nominationForm.reset();
        setDefaultMonths();

        await loadHistory(historyMonthEl.value);
        if (isSuperAdmin) await loadTopNominations();
      } catch (err) {
        console.error(err);
        nominationMessageEl.textContent = "Something went wrong, please try again.";
        nominationMessageEl.className = "text-sm text-red-600";
      } finally {
        submitNominationBtn.disabled = !votingOpen;
      }
    });

    // History filter apply
    refreshHistoryBtn.addEventListener("click", async () => {
      await loadHistory(historyMonthEl.value);
    });

    async function loadHistory(monthKey) {
      historyList.innerHTML = '<div class="text-slate-400 text-xs">Loading nominations...</div>';

      try {
        let qNom;
        if (monthKey) {
          qNom = query(
            collection(db, "nominations"),
            where("monthKey", "==", monthKey),
            orderBy("createdAt", "desc")
          );
        } else {
          qNom = query(collection(db, "nominations"), orderBy("createdAt", "desc"));
        }

        const snap = await getDocs(qNom);

        if (snap.empty) {
          historyList.innerHTML = '<div class="text-slate-400 text-xs">No nominations found for this month.</div>';
          return;
        }

        const items = [];
        snap.forEach((docSnap) => items.push(docSnap.data()));

        historyList.innerHTML = "";
        items.forEach((d) => {
          const createdAtDate = d.createdAt?.toDate ? d.createdAt.toDate() : null;
          const dateStr = createdAtDate ? createdAtDate.toLocaleString() : "(date pending)";

          const div = document.createElement("div");
          div.className = "border border-slate-200 rounded-xl p-3 bg-white";
          div.innerHTML = `
            <div class="flex justify-between gap-3">
              <div>
                <div class="font-semibold text-sm text-slate-900">${d.nomineeName || ""}</div>
                <div class="text-[11px] text-slate-600">${d.nomineeDepartment || ""}</div>
              </div>
              <div class="text-[11px] text-right">
                <div class="text-amber-700">
                  Guest points: <span class="font-semibold">${d.guestFeedbackPoints || 0}</span>
                </div>
                ${d.monthKey ? `<div class="text-slate-500">Month: ${d.monthKey}</div>` : ""}
              </div>
            </div>
            <div class="mt-2 text-xs text-slate-700 whitespace-pre-line">${(d.reason || "").replaceAll("<","&lt;")}</div>
            <div class="mt-2 flex justify-between text-[11px] text-slate-500">
              <span>By: ${d.createdByName || ""} (${d.createdByEmail || ""})</span>
              <span>${dateStr}</span>
            </div>
          `;
          historyList.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        historyList.innerHTML = '<div class="text-red-500 text-xs">Failed to load nominations.</div>';
      }
    }

    // ---------- LEAVE REQUESTS ----------
    leaveForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) {
        alert("Please log in first.");
        return;
      }

      const type = leaveTypeEl.value;
      const startDate = leaveStartEl.value;
      const endDate = leaveEndEl.value;
      const reason = leaveReasonEl.value.trim();

      if (!startDate || !endDate || !reason) {
        leaveMessageEl.textContent = "Please fill start date, end date and reason.";
        leaveMessageEl.className = "text-sm text-red-600";
        return;
      }
      if (endDate < startDate) {
        leaveMessageEl.textContent = "End date cannot be before start date.";
        leaveMessageEl.className = "text-sm text-red-600";
        return;
      }

      submitLeaveBtn.disabled = true;
      leaveMessageEl.textContent = "Submitting...";
      leaveMessageEl.className = "text-sm text-slate-600";

      try {
        await addDoc(collection(db, "leaveRequests"), {
          userUid: currentUser.uid,
          userName: currentUser.displayName || "",
          userEmail: currentUser.email || "",
          type,
          startDate,
          endDate,
          reason,
          status: "pending",
          rejectionComment: "",
          createdAt: serverTimestamp(),
        });

        leaveMessageEl.textContent = "Your leave request has been submitted.";
        leaveMessageEl.className = "text-sm text-emerald-700";
        leaveForm.reset();
        await loadMyLeaveRequests();
        if (isSuperAdmin) await loadAvailability();
      } catch (err) {
        console.error(err);
        leaveMessageEl.textContent = "Something went wrong while submitting your request.";
        leaveMessageEl.className = "text-sm text-red-600";
      } finally {
        submitLeaveBtn.disabled = false;
      }
    });

    async function loadMyLeaveRequests() {
      if (!currentUser) return;

      myLeaveList.innerHTML = '<div class="text-slate-400">Loading your requests...</div>';

      try {
        const qMy = query(
          collection(db, "leaveRequests"),
          where("userUid", "==", currentUser.uid)
        );
        const snap = await getDocs(qMy);

        if (snap.empty) {
          myLeaveList.innerHTML = '<div class="text-slate-400">No leave requests yet.</div>';
          return;
        }

        const rows = [];
        snap.forEach((docSnap) => rows.push(docSnap.data()));
        rows.sort((a, b) => (a.startDate || "").localeCompare(b.startDate || ""));

        myLeaveList.innerHTML = "";
        rows.forEach((r) => {
          const statusClass =
            r.status === "approved"
              ? "text-emerald-700"
              : r.status === "rejected"
              ? "text-red-700"
              : "text-amber-700";

          const div = document.createElement("div");
          div.className = "border border-slate-200 rounded-xl px-3 py-2 bg-white";
          div.innerHTML = `
            <div class="flex justify-between items-start gap-2">
              <div>
                <div class="font-semibold text-xs uppercase text-slate-800">${r.type}</div>
                <div class="text-[11px] text-slate-600">${r.startDate} → ${r.endDate}</div>
                <div class="text-[11px] text-slate-600 mt-1"><span class="font-semibold">Reason:</span> ${r.reason || "-"}</div>
                ${r.status === "rejected" && r.rejectionComment ? `
                  <div class="text-[11px] text-red-700 mt-1"><span class="font-semibold">Comment:</span> ${r.rejectionComment}</div>
                ` : ``}
              </div>
              <div class="text-[11px] font-semibold ${statusClass}">
                ${r.status}
              </div>
            </div>
          `;
          myLeaveList.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        myLeaveList.innerHTML = '<div class="text-red-500">Failed to load your requests.</div>';
      }
    }

    // Availability (approved)
    async function loadAvailability() {
      if (!isSuperAdmin) return;

      availabilityList.innerHTML = '<div class="text-slate-400">Loading approved leave...</div>';

      try {
        const qAll = query(collection(db, "leaveRequests"), where("status", "==", "approved"));
        const snap = await getDocs(qAll);

        if (snap.empty) {
          availabilityList.innerHTML = '<div class="text-slate-400">No approved leave yet.</div>';
          return;
        }

        const rows = [];
        snap.forEach((docSnap) => rows.push(docSnap.data()));
        rows.sort((a, b) => (a.startDate || "").localeCompare(b.startDate || ""));

        availabilityList.innerHTML = "";
        rows.forEach((r) => {
          const div = document.createElement("div");
          div.className = "border border-slate-200 rounded-xl px-3 py-2 bg-white";
          div.innerHTML = `
            <div class="flex justify-between">
              <div class="text-xs font-semibold text-slate-900">${r.userName || r.userEmail}</div>
              <div class="text-[11px] uppercase text-slate-600">${r.type}</div>
            </div>
            <div class="text-[11px] text-slate-600">${r.startDate} → ${r.endDate}</div>
          `;
          availabilityList.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        availabilityList.innerHTML = '<div class="text-red-500 text-xs">Failed to load availability.</div>';
      }
    }

    // Admin leave list
    async function loadAllLeaveRequests() {
      if (!isSuperAdmin) return;

      adminLeaveList.innerHTML = '<div class="text-slate-400">Loading leave requests...</div>';

      try {
        const qAll = query(collection(db, "leaveRequests"), orderBy("createdAt", "desc"));
        const snap = await getDocs(qAll);

        if (snap.empty) {
          adminLeaveList.innerHTML = '<div class="text-slate-400">No leave requests yet.</div>';
          return;
        }

        const rows = [];
        snap.forEach((docSnap) => rows.push({ id: docSnap.id, ...docSnap.data() }));

        adminLeaveList.innerHTML = "";
        rows.forEach((r) => {
          const statusClass =
            r.status === "approved"
              ? "text-emerald-700"
              : r.status === "rejected"
              ? "text-red-700"
              : "text-amber-700";

          const div = document.createElement("div");
          div.className = "border border-slate-200 rounded-xl px-3 py-2 bg-white";
          div.innerHTML = `
            <div class="flex justify-between items-start gap-3">
              <div>
                <div class="text-xs font-semibold text-slate-900">${r.userName || r.userEmail}</div>
                <div class="text-[11px] text-slate-600">${(r.type || "").toUpperCase()} • ${r.startDate} → ${r.endDate}</div>
                <div class="text-[11px] text-slate-600 mt-1"><span class="font-semibold">Reason:</span> ${r.reason || "-"}</div>
                ${r.status === "rejected" && r.rejectionComment ? `<div class="text-[11px] text-red-700 mt-1"><span class="font-semibold">Comment:</span> ${r.rejectionComment}</div>` : ""}
              </div>

              <div class="flex flex-col items-end gap-2">
                <span class="text-[11px] font-semibold ${statusClass}">${r.status}</span>

                ${
                  r.status === "pending"
                    ? `
                    <div class="flex items-center gap-2">
                      <button class="px-2 py-1 text-[11px] rounded-full bg-emerald-600 text-white hover:bg-emerald-700" data-action="approve">
                        Approve
                      </button>
                      <button class="px-2 py-1 text-[11px] rounded-full bg-red-600 text-white hover:bg-red-700" data-action="reject">
                        Reject
                      </button>
                    </div>
                    <input class="mt-1 w-56 border border-slate-200 rounded-lg px-2 py-1 text-[11px]" placeholder="Rejection comment (required to reject)" data-reject-comment />
                    `
                    : ""
                }
              </div>
            </div>
          `;

          const approveBtn = div.querySelector("[data-action='approve']");
          const rejectBtn = div.querySelector("[data-action='reject']");
          const rejectCommentInput = div.querySelector("[data-reject-comment]");

          if (approveBtn) {
            approveBtn.addEventListener("click", () => updateLeaveStatus(r.id, "approved", ""));
          }
          if (rejectBtn) {
            rejectBtn.addEventListener("click", async () => {
              const comment = (rejectCommentInput?.value || "").trim();
              if (!comment) {
                alert("Please enter a rejection comment.");
                return;
              }
              await updateLeaveStatus(r.id, "rejected", comment);
            });
          }

          adminLeaveList.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        adminLeaveList.innerHTML = '<div class="text-red-500 text-xs">Failed to load leave requests.</div>';
      }
    }

    async function updateLeaveStatus(id, status, rejectionComment) {
      if (!isSuperAdmin) return;

      try {
        await updateDoc(doc(db, "leaveRequests", id), {
          status,
          rejectionComment: status === "rejected" ? rejectionComment : "",
          reviewedAt: serverTimestamp(),
          reviewedBy: currentUser?.email || "",
        });

        await loadAllLeaveRequests();
        await loadAvailability();
        await loadMyLeaveRequests();
      } catch (err) {
        console.error(err);
        alert("Failed to update leave status: " + err.message);
      }
    }

    // Top nominations
    async function loadTopNominations() {
      if (!isSuperAdmin) return;

      topNominationsList.innerHTML = '<div class="text-slate-400">Loading nominations...</div>';

      try {
        const qNom = query(collection(db, "nominations"), orderBy("createdAt", "desc"));
        const snap = await getDocs(qNom);

        if (snap.empty) {
          topNominationsList.innerHTML = '<div class="text-slate-400">No nominations yet.</div>';
          return;
        }

        const map = new Map();
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          const key = `${d.nomineeName || ""}||${d.nomineeDepartment || ""}`;
          const current = map.get(key) || {
            nomineeName: d.nomineeName || "",
            nomineeDepartment: d.nomineeDepartment || "",
            count: 0,
            totalGuestPoints: 0,
          };
          current.count += 1;
          current.totalGuestPoints += Number(d.guestFeedbackPoints || 0);
          map.set(key, current);
        });

        const rows = Array.from(map.values());
        rows.sort((a, b) => {
          if (b.count !== a.count) return b.count - a.count;
          return b.totalGuestPoints - a.totalGuestPoints;
        });

        let html = `
          <table class="min-w-full text-xs border border-slate-200 rounded-lg overflow-hidden bg-white">
            <thead class="bg-slate-50">
              <tr>
                <th class="px-2 py-2 text-left">#</th>
                <th class="px-2 py-2 text-left">Nominee</th>
                <th class="px-2 py-2 text-left">Department</th>
                <th class="px-2 py-2 text-right">Nominations</th>
                <th class="px-2 py-2 text-right">Total Points</th>
              </tr>
            </thead>
            <tbody>
        `;
        rows.forEach((r, index) => {
          html += `
            <tr class="border-t">
              <td class="px-2 py-2">${index + 1}</td>
              <td class="px-2 py-2 font-semibold text-slate-900">${r.nomineeName}</td>
              <td class="px-2 py-2 text-slate-700">${r.nomineeDepartment}</td>
              <td class="px-2 py-2 text-right">${r.count}</td>
              <td class="px-2 py-2 text-right">${r.totalGuestPoints}</td>
            </tr>
          `;
        });
        html += "</tbody></table>";

        topNominationsList.innerHTML = html;
      } catch (err) {
        console.error(err);
        topNominationsList.innerHTML = '<div class="text-red-500 text-xs">Failed to load top nominations.</div>';
      }
    }

    // Init defaults for unauth state (so fields not empty)
    setDefaultMonths();
  </script>
</body>
</html>
