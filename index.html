<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Front Office Portal â€“ Rocker of the Month & Leave Request</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-5xl bg-white shadow-xl rounded-2xl p-4 sm:p-6 mb-6">

    <!-- HEADER -->
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
      <div>
        <h1 class="text-2xl font-bold">Front Office Portal</h1>
        <p class="text-sm text-slate-500">
          Rocker of the Month nominations & leave requests â€“ made simple
        </p>
      </div>
      <div id="authArea" class="text-right"></div>
    </header>

    <!-- NAV -->
    <nav id="mainNav" class="mb-4 hidden">
      <div class="inline-flex rounded-xl border bg-slate-50 overflow-hidden text-sm">
        <button data-section="nominate" class="tab-btn px-3 py-2 font-medium bg-white">
          Nominate
        </button>
        <button data-section="history" class="tab-btn px-3 py-2">
          Nomination History
        </button>
        <button data-section="leave" class="tab-btn px-3 py-2">
          My Leave
        </button>
        <button data-section="availability" data-admin-only="true" class="tab-btn px-3 py-2 hidden">
          Leave Availability
        </button>
        <button data-section="admin" data-admin-only="true" class="tab-btn px-3 py-2 hidden">
          Admin
        </button>
      </div>
    </nav>

    <!-- LOGIN SECTION -->
    <section id="loginSection" class="mt-4">
      <div class="border rounded-2xl p-6 text-center">
        <h2 class="text-xl font-semibold mb-2">Sign in to continue</h2>
        <p class="text-sm text-slate-500 mb-4">
          Please log in with your work Gmail to submit nominations and leave requests.
        </p>
        <button
          id="googleSignInBtn"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700"
        >
          <span>Sign in with Google</span>
        </button>
      </div>
    </section>

    <!-- MAIN APP -->
    <main id="appSection" class="hidden">

      <!-- NOMINATION FORM -->
      <section id="section-nominate" class="space-y-5">
        <h2 class="text-xl font-semibold">Rocker of the Month Nomination</h2>
        <p class="text-sm text-slate-500">
          Enter who you are nominating and why. Be specific â€“ real examples help.
        </p>

        <form id="nominationForm" class="space-y-4">
          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">Nominee name</label>
              <input
                id="nomineeName"
                type="text"
                required
                class="w-full border rounded-lg px-3 py-2 text-sm"
                placeholder="e.g. Hamid Basheer."
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Nominee department</label>
              <input
                id="nomineeDepartment"
                type="text"
                required
                class="w-full border rounded-lg px-3 py-2 text-sm"
                placeholder="e.g. Front Office / Section"
              />
            </div>
          </div>

          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">
                Guest feedback recognition points
              </label>
              <select
                id="guestFeedbackPoints"
                class="w-full border rounded-lg px-3 py-2 text-sm"
              >
                <option value="0">0 â€“ No guest comments yet</option>
                <option value="5">5 â€“ Some guest mentions</option>
                <option value="10">10 â€“ Frequent guest recognition</option>
                <option value="15">15 â€“ Outstanding performance</option>
              </select>
              <p class="text-[11px] text-slate-400 mt-1">
                You can adjust this later with MOD based on actual guest reviews.
              </p>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">Nomination month</label>
              <input
                id="nominationMonth"
                type="month"
                class="w-full border rounded-lg px-3 py-2 text-sm"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Why are you nominating this person?</label>
            <textarea
              id="nominationReason"
              rows="4"
              required
              class="w-full border rounded-lg px-3 py-2 text-sm"
              placeholder="Describe situations, guest feedback, teamwork, attitude, going extra mile..."
            ></textarea>
          </div>

          <button
            id="submitNominationBtn"
            type="submit"
            class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 disabled:opacity-60"
          >
            Submit nomination
          </button>
        </form>

        <div id="nominationMessage" class="text-sm mt-2"></div>
      </section>

      <!-- NOMINATION HISTORY -->
      <section id="section-history" class="space-y-4 hidden">
        <h2 class="text-xl font-semibold">Nomination History</h2>
        <p class="text-sm text-slate-500">
          Recent nominations submitted by the team.
        </p>

        <div id="historyContainer" class="border rounded-2xl p-3 max-h-[420px] overflow-y-auto text-sm">
          <div id="historyList" class="space-y-3"></div>
        </div>
      </section>

      <!-- MY LEAVE -->
      <section id="section-leave" class="space-y-4 hidden">
        <h2 class="text-xl font-semibold">My Leave Requests</h2>
        <p class="text-sm text-slate-500">
          Submit off-day or annual leave requests. Management will review and update the status.
        </p>

        <form id="leaveForm" class="space-y-4">
          <div class="grid sm:grid-cols-3 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">Leave type</label>
              <select
                id="leaveType"
                class="w-full border rounded-lg px-3 py-2 text-sm"
              >
                <option value="off-day">Off day</option>
                <option value="annual">Annual leave</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">Start date</label>
              <input
                id="leaveStart"
                type="date"
                required
                class="w-full border rounded-lg px-3 py-2 text-sm"
              />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">End date</label>
              <input
                id="leaveEnd"
                type="date"
                required
                class="w-full border rounded-lg px-3 py-2 text-sm"
              />
            </div>
          </div>

          <button
            id="submitLeaveBtn"
            type="submit"
            class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 disabled:opacity-60"
          >
            Submit leave request
          </button>
        </form>

        <div id="leaveMessage" class="text-sm mt-2"></div>

        <div>
          <h3 class="text-sm font-semibold mt-4 mb-2">My requests</h3>
          <div id="myLeaveList" class="border rounded-2xl p-3 max-h-[260px] overflow-y-auto text-xs space-y-2"></div>
        </div>
      </section>

      <!-- AVAILABILITY (ADMIN ONLY) -->
      <section id="section-availability" class="space-y-4 hidden">
        <h2 class="text-xl font-semibold">Leave Availability (Approved)</h2>
        <p class="text-sm text-slate-500">
          Overview of approved leave to help plan the operation.
        </p>

        <div id="availabilityList" class="border rounded-2xl p-3 max-h-[420px] overflow-y-auto text-xs space-y-2"></div>
      </section>

      <!-- ADMIN SECTION -->
      <section id="section-admin" class="space-y-6 hidden">
        <h2 class="text-xl font-semibold">Admin Panel</h2>

        <!-- Leave approvals -->
        <div>
          <h3 class="text-lg font-semibold mb-1">Leave Requests â€“ Approvals</h3>
          <p class="text-xs text-slate-500 mb-2">
            Approve or reject pending off-day and annual leave requests.
          </p>
          <div id="adminLeaveList" class="border rounded-2xl p-3 max-h-[320px] overflow-y-auto text-xs space-y-2"></div>
        </div>

        <!-- Top nominations -->
        <div>
          <h3 class="text-lg font-semibold mb-1">Top Nominations</h3>
          <p class="text-xs text-slate-500 mb-2">
            Ranked by number of nominations, then guest feedback points.
          </p>
          <div id="topNominationsList" class="border rounded-2xl p-3 max-h-[320px] overflow-y-auto text-xs"></div>
        </div>
      </section>

    </main>
  </div>

  <!-- FIREBASE & APP LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      where,
      orderBy,
      serverTimestamp,
      doc,
      updateDoc,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ðŸ”§ Replace with your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCX44FHUpCQY-ma62m89rx3ah6s_gJtcY4",
  authDomain: "band-portal-8225e.firebaseapp.com",
  projectId: "band-portal-8225e",
  storageBucket: "band-portal-8225e.firebasestorage.app",
  messagingSenderId: "975187203610",
  appId: "1:975187203610:web:c044a2e0d3e2fd29b1e3a3"
};

    // ðŸ”§ Set your super admin Gmail addresses here
    const SUPER_ADMIN_EMAILS = [
      "hamid.bashyr@gmail.com",
      "eslamhzaki7@gmail.com",
    ];

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const authArea = document.getElementById("authArea");
    const loginSection = document.getElementById("loginSection");
    const appSection = document.getElementById("appSection");
    const mainNav = document.getElementById("mainNav");
    const googleSignInBtn = document.getElementById("googleSignInBtn");
    const tabButtons = document.querySelectorAll(".tab-btn");

    const sections = {
      nominate: document.getElementById("section-nominate"),
      history: document.getElementById("section-history"),
      leave: document.getElementById("section-leave"),
      availability: document.getElementById("section-availability"),
      admin: document.getElementById("section-admin"),
    };

    let currentUser = null;
    let isSuperAdmin = false;

    googleSignInBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        alert("Login failed: " + err.message);
      }
    });

    async function handleSignOut() {
      await signOut(auth);
    }

    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;
      isSuperAdmin = !!(user && SUPER_ADMIN_EMAILS.includes(user.email));

      if (!user) {
        authArea.innerHTML = "";
        loginSection.classList.remove("hidden");
        appSection.classList.add("hidden");
        mainNav.classList.add("hidden");
        return;
      }

      authArea.innerHTML = `
        <div class="text-xs text-slate-600">
          <div class="font-semibold">${user.displayName || "Logged in"}</div>
          <div>${user.email || ""}</div>
          <div class="mt-1">
            <span class="inline-flex items-center rounded-full border px-2 py-0.5 text-[11px] ${
              isSuperAdmin ? "border-emerald-300 text-emerald-700 bg-emerald-50" : "border-slate-200 text-slate-500"
            }">
              ${isSuperAdmin ? "Super Admin" : "Staff"}
            </span>
          </div>
          <button id="logoutBtn" class="mt-1 inline-flex text-[11px] text-indigo-600 border border-indigo-200 rounded-full px-2 py-0.5 hover:bg-indigo-50">
            Sign out
          </button>
        </div>
      `;
      document.getElementById("logoutBtn").addEventListener("click", handleSignOut);

      loginSection.classList.add("hidden");
      appSection.classList.remove("hidden");
      mainNav.classList.remove("hidden");

      // Show/hide admin-only buttons + sections
      document.querySelectorAll("[data-admin-only='true']").forEach((el) => {
        el.classList.toggle("hidden", !isSuperAdmin);
      });
      sections.availability.classList.toggle("hidden", !isSuperAdmin);
      sections.admin.classList.toggle("hidden", !isSuperAdmin);

      setDefaultMonth();
      switchSection("nominate");
      await loadHistory();
      await loadMyLeaveRequests();
      if (isSuperAdmin) {
        await loadAvailability();
        await loadAllLeaveRequests();
        await loadTopNominations();
      }
    });

    function switchSection(key) {
      for (const name in sections) {
        sections[name].classList.toggle("hidden", name !== key);
      }
      tabButtons.forEach((btn) => {
        if (btn.dataset.section === key) {
          btn.classList.add("bg-white", "font-semibold");
        } else {
          btn.classList.remove("bg-white", "font-semibold");
        }
      });
    }

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", async () => {
        const section = btn.dataset.section;
        switchSection(section);
        if (section === "history") await loadHistory();
        if (section === "leave") await loadMyLeaveRequests();
        if (section === "availability" && isSuperAdmin) await loadAvailability();
        if (section === "admin" && isSuperAdmin) {
          await loadAllLeaveRequests();
          await loadTopNominations();
        }
      });
    });

    // NOMINATIONS
    const nominationForm = document.getElementById("nominationForm");
    const nomineeNameEl = document.getElementById("nomineeName");
    const nomineeDepartmentEl = document.getElementById("nomineeDepartment");
    const guestFeedbackPointsEl = document.getElementById("guestFeedbackPoints");
    const nominationMonthEl = document.getElementById("nominationMonth");
    const nominationReasonEl = document.getElementById("nominationReason");
    const nominationMessageEl = document.getElementById("nominationMessage");
    const submitNominationBtn = document.getElementById("submitNominationBtn");
    const historyList = document.getElementById("historyList");

    function setDefaultMonth() {
      const now = new Date();
      const value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
      nominationMonthEl.value = value;
    }

    setDefaultMonth();

    nominationForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) {
        alert("Please log in first.");
        return;
      }

      const nomineeName = nomineeNameEl.value.trim();
      const nomineeDepartment = nomineeDepartmentEl.value.trim();
      const guestFeedbackPoints = Number(guestFeedbackPointsEl.value || "0");
      const monthKey = nominationMonthEl.value || null;
      const reason = nominationReasonEl.value.trim();

      if (!nomineeName || !nomineeDepartment || !reason) {
        nominationMessageEl.textContent = "Please fill all required fields.";
        nominationMessageEl.className = "text-sm text-red-600";
        return;
      }

      submitNominationBtn.disabled = true;

      try {
        await addDoc(collection(db, "nominations"), {
          nomineeName,
          nomineeDepartment,
          guestFeedbackPoints,
          monthKey,
          reason,
          createdByUid: currentUser.uid,
          createdByName: currentUser.displayName || "",
          createdByEmail: currentUser.email || "",
          createdAt: serverTimestamp(),
        });

        nominationMessageEl.textContent = "Thank you! Your nomination has been submitted.";
        nominationMessageEl.className = "text-sm text-green-600";
        nominationForm.reset();
        setDefaultMonth();
        await loadHistory();
        if (isSuperAdmin) await loadTopNominations();
      } catch (err) {
        console.error(err);
        nominationMessageEl.textContent = "Something went wrong, please try again.";
        nominationMessageEl.className = "text-sm text-red-600";
      } finally {
        submitNominationBtn.disabled = false;
      }
    });

    async function loadHistory() {
      historyList.innerHTML = '<div class="text-slate-400 text-xs">Loading nominations...</div>';
      try {
        const qNom = query(
          collection(db, "nominations"),
          orderBy("createdAt", "desc")
        );
        const snap = await getDocs(qNom);

        if (snap.empty) {
          historyList.innerHTML = '<div class="text-slate-400 text-xs">No nominations yet.</div>';
          return;
        }

        const items = [];
        snap.forEach((docSnap) => {
          items.push(docSnap.data());
        });

        historyList.innerHTML = "";
        items.forEach((d) => {
          const createdAtDate = d.createdAt?.toDate ? d.createdAt.toDate() : null;
          const dateStr = createdAtDate ? createdAtDate.toLocaleString() : "(date pending)";
          const div = document.createElement("div");
          div.className = "border rounded-xl p-2.5";
          div.innerHTML = `
            <div class="flex justify-between gap-2">
              <div>
                <div class="font-semibold text-sm">${d.nomineeName || ""}</div>
                <div class="text-[11px] text-slate-500">${d.nomineeDepartment || ""}</div>
              </div>
              <div class="text-[11px] text-amber-700 text-right">
                Guest feedback points:
                <span class="font-semibold">${d.guestFeedbackPoints || 0}</span>
                ${d.monthKey ? `<div>Month: ${d.monthKey}</div>` : ""}
              </div>
            </div>
            <div class="mt-2 text-xs text-slate-700 whitespace-pre-line">
              ${d.reason || ""}
            </div>
            <div class="mt-1 flex justify-between text-[11px] text-slate-400">
              <span>By: ${d.createdByName || ""} (${d.createdByEmail || ""})</span>
              <span>${dateStr}</span>
            </div>
          `;
          historyList.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        historyList.innerHTML =
          '<div class="text-red-500 text-xs">Failed to load nominations.</div>';
      }
    }

    // LEAVE REQUESTS (MY)
    const leaveForm = document.getElementById("leaveForm");
    const leaveTypeEl = document.getElementById("leaveType");
    const leaveStartEl = document.getElementById("leaveStart");
    const leaveEndEl = document.getElementById("leaveEnd");
    const leaveMessageEl = document.getElementById("leaveMessage");
    const submitLeaveBtn = document.getElementById("submitLeaveBtn");
    const myLeaveList = document.getElementById("myLeaveList");

    leaveForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) {
        alert("Please log in first.");
        return;
      }

      const type = leaveTypeEl.value;
      const startDate = leaveStartEl.value;
      const endDate = leaveEndEl.value;

      if (!startDate || !endDate) {
        leaveMessageEl.textContent = "Please select start and end dates.";
        leaveMessageEl.className = "text-sm text-red-600";
        return;
      }
      if (endDate < startDate) {
        leaveMessageEl.textContent = "End date cannot be before start date.";
        leaveMessageEl.className = "text-sm text-red-600";
        return;
      }

      submitLeaveBtn.disabled = true;

      try {
        await addDoc(collection(db, "leaveRequests"), {
          userUid: currentUser.uid,
          userName: currentUser.displayName || "",
          userEmail: currentUser.email || "",
          type,
          startDate,
          endDate,
          status: "pending",
          createdAt: serverTimestamp(),
        });

        leaveMessageEl.textContent = "Your leave request has been submitted.";
        leaveMessageEl.className = "text-sm text-green-600";
        leaveForm.reset();
        await loadMyLeaveRequests();
        if (isSuperAdmin) await loadAvailability();
      } catch (err) {
        console.error(err);
        leaveMessageEl.textContent =
          "Something went wrong while submitting your request.";
        leaveMessageEl.className = "text-sm text-red-600";
      } finally {
        submitLeaveBtn.disabled = false;
      }
    });

    async function loadMyLeaveRequests() {
      if (!currentUser) return;
      myLeaveList.innerHTML =
        '<div class="text-slate-400">Loading your requests...</div>';
      try {
        const qMy = query(
          collection(db, "leaveRequests"),
          where("userUid", "==", currentUser.uid)
        );
        const snap = await getDocs(qMy);

        if (snap.empty) {
          myLeaveList.innerHTML =
            '<div class="text-slate-400">No leave requests yet.</div>';
          return;
        }

        const rows = [];
        snap.forEach((docSnap) => rows.push(docSnap.data()));
        rows.sort((a, b) => (a.startDate || "").localeCompare(b.startDate || ""));

        myLeaveList.innerHTML = "";
        rows.forEach((r) => {
          const div = document.createElement("div");
          div.className =
            "border rounded-xl px-2 py-1.5 flex justify-between items-center";
          div.innerHTML = `
            <div>
              <div class="font-semibold text-xs uppercase">${r.type}</div>
              <div class="text-[11px] text-slate-600">
                ${r.startDate} â†’ ${r.endDate}
              </div>
            </div>
            <div class="text-[11px] font-semibold ${
              r.status === "approved"
                ? "text-emerald-600"
                : r.status === "rejected"
                ? "text-red-600"
                : "text-amber-600"
            }">
              ${r.status}
            </div>
          `;
          myLeaveList.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        myLeaveList.innerHTML =
          '<div class="text-red-500">Failed to load your requests.</div>';
      }
    }

    // AVAILABILITY (ADMIN)
    const availabilityList = document.getElementById("availabilityList");

    async function loadAvailability() {
      if (!isSuperAdmin) return;
      availabilityList.innerHTML =
        '<div class="text-slate-400">Loading approved leave...</div>';
      try {
        const qAll = query(
          collection(db, "leaveRequests"),
          where("status", "==", "approved")
        );
        const snap = await getDocs(qAll);

        if (snap.empty) {
          availabilityList.innerHTML =
            '<div class="text-slate-400">No approved leave yet.</div>';
          return;
        }

        const rows = [];
        snap.forEach((docSnap) => rows.push(docSnap.data()));
        rows.sort((a, b) => (a.startDate || "").localeCompare(b.startDate || ""));

        availabilityList.innerHTML = "";
        rows.forEach((r) => {
          const div = document.createElement("div");
          div.className = "border rounded-xl px-2 py-1.5";
          div.innerHTML = `
            <div class="flex justify-between">
              <div class="text-xs font-semibold">${r.userName || r.userEmail}</div>
              <div class="text-[11px] uppercase">${r.type}</div>
            </div>
            <div class="text-[11px] text-slate-600">
              ${r.startDate} â†’ ${r.endDate}
            </div>
          `;
          availabilityList.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        availabilityList.innerHTML =
          '<div class="text-red-500 text-xs">Failed to load availability.</div>';
      }
    }

    // ADMIN â€“ LEAVE APPROVALS
    const adminLeaveList = document.getElementById("adminLeaveList");

    async function loadAllLeaveRequests() {
      if (!isSuperAdmin) return;
      adminLeaveList.innerHTML =
        '<div class="text-slate-400">Loading leave requests...</div>';
      try {
        const qAll = query(
          collection(db, "leaveRequests"),
          orderBy("createdAt", "desc")
        );
        const snap = await getDocs(qAll);

        if (snap.empty) {
          adminLeaveList.innerHTML =
            '<div class="text-slate-400">No leave requests yet.</div>';
          return;
        }

        const rows = [];
        snap.forEach((docSnap) => {
          rows.push({ id: docSnap.id, ...docSnap.data() });
        });

        adminLeaveList.innerHTML = "";
        rows.forEach((r) => {
          const div = document.createElement("div");
          div.className =
            "border rounded-xl px-2 py-1.5 flex justify-between items-center gap-2";
          const statusClass =
            r.status === "approved"
              ? "text-emerald-600"
              : r.status === "rejected"
              ? "text-red-600"
              : "text-amber-600";
          div.innerHTML = `
            <div>
              <div class="text-xs font-semibold">${r.userName || r.userEmail}</div>
              <div class="text-[11px] text-slate-600">
                ${r.type.toUpperCase()} â€¢ ${r.startDate} â†’ ${r.endDate}
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-[11px] font-semibold ${statusClass}">
                ${r.status}
              </span>
              ${
                r.status === "pending"
                  ? `
                <button class="px-2 py-0.5 text-[11px] rounded-full bg-emerald-600 text-white hover:bg-emerald-700" data-action="approve">
                  Approve
                </button>
                <button class="px-2 py-0.5 text-[11px] rounded-full bg-red-600 text-white hover:bg-red-700" data-action="reject">
                  Reject
                </button>`
                  : ""
              }
            </div>
          `;

          const approveBtn = div.querySelector("[data-action='approve']");
          const rejectBtn = div.querySelector("[data-action='reject']");
          if (approveBtn) {
            approveBtn.addEventListener("click", () =>
              updateLeaveStatus(r.id, "approved")
            );
          }
          if (rejectBtn) {
            rejectBtn.addEventListener("click", () =>
              updateLeaveStatus(r.id, "rejected")
            );
          }

          adminLeaveList.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        adminLeaveList.innerHTML =
          '<div class="text-red-500 text-xs">Failed to load leave requests.</div>';
      }
    }

    async function updateLeaveStatus(id, status) {
      if (!isSuperAdmin) return;
      try {
        await updateDoc(doc(db, "leaveRequests", id), { status });
        await loadAllLeaveRequests();
        await loadAvailability();
        if (currentUser) await loadMyLeaveRequests();
      } catch (err) {
        console.error(err);
        alert("Failed to update leave status: " + err.message);
      }
    }

    // ADMIN â€“ TOP NOMINATIONS
    const topNominationsList = document.getElementById("topNominationsList");

    async function loadTopNominations() {
      if (!isSuperAdmin) return;
      topNominationsList.innerHTML =
        '<div class="text-slate-400">Loading nominations...</div>';
      try {
        const qNom = query(
          collection(db, "nominations"),
          orderBy("createdAt", "desc")
        );
        const snap = await getDocs(qNom);

        if (snap.empty) {
          topNominationsList.innerHTML =
            '<div class="text-slate-400">No nominations yet.</div>';
          return;
        }

        // Aggregate by nominee (name + department)
        const map = new Map();
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          const key = `${d.nomineeName || ""}||${d.nomineeDepartment || ""}`;
          const current = map.get(key) || {
            nomineeName: d.nomineeName || "",
            nomineeDepartment: d.nomineeDepartment || "",
            count: 0,
            totalGuestPoints: 0,
          };
          current.count += 1;
          current.totalGuestPoints += Number(d.guestFeedbackPoints || 0);
          map.set(key, current);
        });

        const rows = Array.from(map.values());
        rows.sort((a, b) => {
          if (b.count !== a.count) return b.count - a.count;
          return b.totalGuestPoints - a.totalGuestPoints;
        });

        // Render as simple table
        let html = `
          <table class="min-w-full text-xs border border-slate-200 rounded-lg overflow-hidden">
            <thead class="bg-slate-100">
              <tr>
                <th class="px-2 py-1 text-left">#</th>
                <th class="px-2 py-1 text-left">Nominee</th>
                <th class="px-2 py-1 text-left">Department</th>
                <th class="px-2 py-1 text-right">Nominations</th>
                <th class="px-2 py-1 text-right">Total Points</th>
              </tr>
            </thead>
            <tbody>
        `;
        rows.forEach((r, index) => {
          html += `
            <tr class="border-t">
              <td class="px-2 py-1">${index + 1}</td>
              <td class="px-2 py-1">${r.nomineeName}</td>
              <td class="px-2 py-1">${r.nomineeDepartment}</td>
              <td class="px-2 py-1 text-right">${r.count}</td>
              <td class="px-2 py-1 text-right">${r.totalGuestPoints}</td>
            </tr>
          `;
        });
        html += "</tbody></table>";

        topNominationsList.innerHTML = html;
      } catch (err) {
        console.error(err);
        topNominationsList.innerHTML =
          '<div class="text-red-500 text-xs">Failed to load top nominations.</div>';
      }
    }
  </script>
</body>
</html>
